# 测试指南 (Testing Guide)

## 快速测试步骤 (Quick Testing Steps)

本指南帮助你快速验证新实现的功能。

## 前置准备 (Prerequisites)

### 1. 确保环境正确
```bash
cd /workspace
python3 --version  # 应该是 Python 3.x
```

### 2. 准备测试数据
你需要一个包含以下列的 CSV 文件：
- `V_atomic` - 原子体积 (Å³/atom)
- `Pressure (GPa)` - 压力 (GPa)

**示例数据格式**:
```csv
V_atomic,Pressure (GPa)
17.5,0.0
17.0,5.2
16.5,10.8
16.0,17.1
15.5,24.2
15.0,32.1
14.5,41.0
14.0,51.0
```

## 测试场景 (Test Scenarios)

### 测试 1: 算法复刻 - 正常拟合 ✅

**目的**: 验证 BM3 拟合算法工作正常

**步骤**:
1. 运行 GUI：
   ```bash
   python3 interactive_eos_gui.py
   ```

2. 加载测试数据：
   - 点击 "Load CSV File"
   - 选择你的测试数据文件

3. 确保模型选择：
   - EoS Model 下拉菜单选择 "Birch-Murnaghan 3rd"

4. 确认参数解锁：
   - 检查所有 Lock 复选框都是**未选中**状态

5. 执行拟合：
   - 点击 "Fit Unlocked Parameters"

**预期结果**:
- ✅ 拟合成功完成
- ✅ 参数显示合理值：
  - V₀ ≈ 最大体积 × 1.01-1.05
  - B₀ ≈ 80-300 GPa
  - B₀' ≈ 3.0-6.0
- ✅ R² > 0.95
- ✅ 拟合曲线与数据点吻合良好

**截图位置**: 保存拟合结果图

---

### 测试 2: 参数锁定警告 ⚠️

**目的**: 验证 BM3 参数锁定检查功能

**步骤**:
1. 在测试 1 的基础上继续

2. 锁定一个参数：
   - 选中 V₀ 旁边的 Lock 复选框

3. 尝试拟合：
   - 点击 "Fit Unlocked Parameters"

**预期结果**:
- ✅ 弹出警告对话框
- ✅ 警告标题："Birch-Murnaghan 3rd Order Constraint"
- ✅ 警告内容包含：
  - "ALL parameters must be unlocked"
  - "Currently locked: V₀"
  - 解释为什么需要解锁
- ✅ 拟合被阻止（参数值不变）

**截图位置**: 保存警告对话框截图

---

### 测试 3: 自动解锁功能 ℹ️

**目的**: 验证切换到 BM3 时自动解锁参数

**步骤**:
1. 切换到其他模型：
   - EoS Model 选择 "Murnaghan"

2. 锁定多个参数：
   - 选中 V₀ 的 Lock
   - 选中 B₀ 的 Lock
   - 选中 B₀' 的 Lock

3. 切换回 BM3：
   - EoS Model 选择 "Birch-Murnaghan 3rd"

**预期结果**:
- ✅ 弹出信息对话框
- ✅ 信息标题："Parameters Unlocked"
- ✅ 信息内容说明：
  - "All parameters have been automatically unlocked"
  - 解释 F-f 线性化方法的要求
- ✅ 所有 Lock 复选框自动变为**未选中**状态
- ✅ 图表自动更新（如果有数据）

**截图位置**: 保存信息对话框截图

---

### 测试 4: 多策略拟合 🔄

**目的**: 验证多策略拟合功能

**步骤**:
1. 加载测试数据（同测试 1）

2. 选择 BM3 模型

3. 确保所有参数解锁

4. 点击 "Try Multiple Strategies"

**预期结果**:
- ✅ 控制台输出策略尝试过程：
  ```
  ============================================================
  Trying multiple fitting strategies...
  ============================================================
    Strategy 1: CrysFML Replicated F-f Linearization...
      Success: R² = 0.xxxxx, RMSE = x.xxxx, B0' = x.xxx
  ```
- ✅ 选择最佳拟合结果
- ✅ 参数值更新
- ✅ 图表更新

**截图位置**: 保存控制台输出和拟合结果

---

### 测试 5: 手动参数调整 🎛️

**目的**: 验证手动调整参数功能

**步骤**:
1. 加载测试数据

2. 选择 BM3 模型

3. 手动修改参数：
   - V₀ 改为一个接近最大体积的值
   - B₀ 改为 150
   - B₀' 改为 4.0

4. 点击 "Update Plot" 或按 Enter

**预期结果**:
- ✅ 图表立即更新
- ✅ 拟合曲线反映新参数
- ✅ R² 和 RMSE 更新
- ✅ 结果窗口更新

---

### 测试 6: 正则化强度调节 📊

**目的**: 验证正则化参数调整功能

**步骤**:
1. 加载测试数据

2. 选择 BM3 模型

3. 调整正则化滑块：
   - 移动 "B0' Regularization" 滑块
   - 尝试不同的值（0.1, 1.0, 5.0, 10.0）

4. 每次调整后点击 "Fit Unlocked Parameters"

**预期结果**:
- ✅ 不同正则化强度给出不同的 B₀' 值
- ✅ 高正则化 → B₀' 更接近 4.0
- ✅ 低正则化 → B₀' 更灵活
- ✅ 所有拟合都收敛

**记录**: 记录不同正则化强度下的 B₀' 值

---

### 测试 7: 参数重置 🔄

**目的**: 验证参数重置功能

**步骤**:
1. 加载测试数据

2. 选择 BM3 模型

3. 手动修改参数为任意值

4. 点击 "Reset to Initial Guess"

**预期结果**:
- ✅ 参数恢复为智能初始猜测值
- ✅ V₀ ≈ 最大体积 × 1.005-1.01
- ✅ B₀ ≈ 从压缩率估计的值
- ✅ B₀' = 4.0
- ✅ 图表自动更新

---

### 测试 8: 其他 EoS 模型 ✅

**目的**: 确保其他模型不受影响

**步骤**:
1. 加载测试数据

2. 选择 "Murnaghan" 模型

3. 锁定 B₀' 参数

4. 点击 "Fit Unlocked Parameters"

**预期结果**:
- ✅ 拟合成功（不显示警告）
- ✅ 锁定的参数值不变
- ✅ 其他参数正常优化
- ✅ 向后兼容性良好

---

## 快速检查清单 (Quick Checklist)

在提交或发布前，确保：

- [ ] 测试 1: BM3 正常拟合 ✅
- [ ] 测试 2: 参数锁定警告 ✅
- [ ] 测试 3: 自动解锁功能 ✅
- [ ] 测试 4: 多策略拟合 ✅
- [ ] 测试 5: 手动参数调整 ✅
- [ ] 测试 6: 正则化调节 ✅
- [ ] 测试 7: 参数重置 ✅
- [ ] 测试 8: 其他模型兼容 ✅

## 常见问题 (Common Issues)

### 问题 1: GUI 无法启动
**可能原因**: 缺少依赖
**解决方案**:
```bash
pip install numpy pandas matplotlib PyQt6
```

### 问题 2: 拟合失败
**可能原因**: 
- 数据质量问题
- 初始参数不合理
**解决方案**:
- 检查数据文件格式
- 尝试调整正则化强度
- 使用 "Try Multiple Strategies"

### 问题 3: 参数不合理
**可能原因**:
- V₀ 过小
- B₀ 负值或过大
- B₀' 超出范围
**解决方案**:
- 检查数据单位
- 确保体积单位为 Å³/atom
- 确保压力单位为 GPa

### 问题 4: 图表不更新
**可能原因**: 
- 参数输入错误
- 数据未加载
**解决方案**:
- 检查参数值是否为有效数字
- 重新加载数据
- 点击 "Update Plot"

## 性能基准 (Performance Benchmarks)

典型拟合时间（10-20 个数据点）：

| 操作 | 预期时间 |
|-----|---------|
| 加载数据 | < 1 秒 |
| 手动参数更新 | < 0.1 秒 |
| BM3 拟合 | 0.5-2 秒 |
| 多策略拟合 | 2-5 秒 |

如果超过这些时间，可能需要优化。

## 报告 Bug (Bug Reporting)

如果发现问题，请记录：

1. **重现步骤**: 详细操作步骤
2. **预期行为**: 应该发生什么
3. **实际行为**: 实际发生了什么
4. **错误消息**: 完整的错误消息
5. **数据**: 测试数据文件（如果可以分享）
6. **环境**: Python 版本、操作系统

## 高级测试 (Advanced Testing)

### 数值一致性测试
比较 GUI 和模块的拟合结果：

```python
# 使用相同数据
import numpy as np
from crysfml_eos_module import CrysFMLEoS, EoSType

V_data = np.array([...])  # 你的数据
P_data = np.array([...])

# 模块拟合
fitter = CrysFMLEoS(eos_type=EoSType.BIRCH_MURNAGHAN_3RD, 
                     regularization_strength=1.0)
module_params = fitter.fit(V_data, P_data)

# GUI 拟合（手动记录结果）
# 比较：
# - V0: 差异应 < 0.001%
# - B0: 差异应 < 0.1%
# - B0': 差异应 < 0.01
```

### 压力测试
使用大量数据点（100+）测试性能和稳定性。

### 边界测试
- 极小压力范围（< 1 GPa）
- 极大压力范围（> 100 GPa）
- 少量数据点（< 5 个）

---

**测试完成后**:
- 记录所有测试结果
- 保存关键截图
- 更新文档（如有需要）
- 报告任何问题或改进建议

**祝测试顺利！** 🎉
