# Batch Fit 模块测试指南

## 快速测试

### 1. 启动测试
```bash
cd /workspace
python main.py
```

**预期结果：**
- ✅ 程序正常启动
- ✅ 侧边栏显示 "📊 Batch Fit"
- ✅ 侧边栏**不显示** "📈 curvefit"

---

### 2. 打开Batch Fit模块
**操作：** 点击侧边栏 "📊 Batch Fit" 按钮

**预期结果：**
- ✅ 右侧显示批处理界面
- ✅ 左侧有文件列表区域
- ✅ 右侧有控制面板和绘图区域
- ✅ 顶部显示 "📊 Batch Peak Fitting - Interactive Mode"
- ✅ 有 "📁 Load Folder" 按钮

---

### 3. 加载测试数据
**操作：** 
1. 点击 "📁 Load Folder"
2. 选择包含 .xy 文件的文件夹

**预期结果：**
- ✅ 左侧文件列表填充文件名
- ✅ 显示 "Loaded X files"
- ✅ 第一个文件自动加载
- ✅ 绘图区域显示XRD数据
- ✅ 自动检测的峰显示为红色虚线

---

### 4. 交互式编辑测试

#### 4.1 添加峰
**操作：**
1. 确保 "🔴 Peak" 模式选中
2. 左键点击图像上的峰位置

**预期结果：**
- ✅ 点击位置出现红色虚线
- ✅ 自动吸附到最近的峰

#### 4.2 删除峰
**操作：**
1. 右键点击现有峰的位置

**预期结果：**
- ✅ 最近的峰被删除
- ✅ 红色虚线消失

#### 4.3 添加背景点
**操作：**
1. 点击 "🔵 Background" 按钮
2. 左键点击图像上的背景位置

**预期结果：**
- ✅ 点击位置出现浅蓝色方块
- ✅ 如有多个背景点，显示蓝色虚线连接

#### 4.4 删除背景点
**操作：**
1. 在背景模式下，右键点击背景点

**预期结果：**
- ✅ 最近的背景点被删除

---

### 5. 拟合功能测试

#### 5.1 单文件拟合
**操作：**
1. 确保有至少一个峰标记
2. 点击 "✨ Fit Current" 或按 **Space** 键

**预期结果：**
- ✅ 弹出 "Fit Successful" 对话框
- ✅ 显示 R² 值（应该 > 0.9）
- ✅ 图像上显示红色拟合曲线
- ✅ 拟合曲线叠加在数据上

#### 5.2 自动批量拟合
**操作：**
1. 在第一个文件调整好峰
2. 点击 "⚡ Auto Fit (Enter)" 或按 **Enter** 键

**预期结果：**
- ✅ 自动切换到下一个文件
- ✅ 使用相同的峰配置
- ✅ 自动拟合并继续
- ✅ 如果 R² 低于阈值，暂停并提示
- ✅ 所有文件处理完后显示 "Auto-Fitting Complete"

---

### 6. Overlap模式测试

#### 6.1 启用Overlap
**操作：**
1. 加载文件并调整第一个
2. 点击 "📊 Overlap (O)" 或按 **O** 键

**预期结果：**
- ✅ 按钮变为选中状态（深色）
- ✅ 按钮文字变为 "📊 Overlap (1)"
- ✅ 状态栏显示 "[Overlap: 1 files]"

#### 6.2 添加更多文件到Overlay
**操作：**
1. 点击 "Next ➡" 或按 **→** 键切换到下一个文件

**预期结果：**
- ✅ 前一个文件数据保留在背景（半透明）
- ✅ 当前文件数据显示为黑色
- ✅ 按钮文字更新为 "📊 Overlap (2)"
- ✅ 可以看到两个文件的峰位对比

#### 6.3 拟合Overlapped文件
**操作：**
1. 在Overlap模式下，按 **Enter** 键

**预期结果：**
- ✅ 对所有overlapped文件进行拟合
- ✅ 显示成功/失败统计
- ✅ 拟合曲线显示在图上

#### 6.4 清除Overlay
**操作：**
1. 点击 "Clear Overlay" 按钮

**预期结果：**
- ✅ 所有overlapped数据清除
- ✅ 只显示当前文件
- ✅ Overlap按钮恢复为 "📊 Overlap (O)"

---

### 7. 快捷键测试

| 按键 | 测试操作 | 预期结果 |
|------|---------|---------|
| **Enter** | 按Enter键 | ✅ 开始Auto Fit |
| **Space** | 按Space键 | ✅ 拟合当前文件 |
| **←** | 按左箭头 | ✅ 切换到上一个文件 |
| **→** | 按右箭头 | ✅ 切换到下一个文件 |
| **A** | 按A键 | ✅ 自动检测峰 |
| **C** | 按C键 | ✅ 清除所有峰和背景点 |
| **P** | 按P键 | ✅ 切换到峰模式 |
| **B** | 按B键 | ✅ 切换到背景模式 |
| **R** | 按R键 | ✅ 重置缩放 |
| **O** | 按O键 | ✅ Toggle Overlap模式 |

---

### 8. 缩放功能测试

#### 8.1 滚轮缩放
**操作：**
1. 鼠标悬停在图像上
2. 滚动鼠标滚轮

**预期结果：**
- ✅ 向上滚动：放大（Zoom In）
- ✅ 向下滚动：缩小（Zoom Out）
- ✅ 以鼠标位置为中心缩放

#### 8.2 重置缩放
**操作：**
1. 缩放后，点击 "🔍 Reset Zoom" 或按 **R** 键

**预期结果：**
- ✅ 视图恢复到原始范围
- ✅ 显示完整数据

---

### 9. 文件导航测试

#### 9.1 点击文件列表
**操作：**
1. 点击左侧文件列表中的任意文件

**预期结果：**
- ✅ 该文件被加载
- ✅ 文件在列表中高亮
- ✅ 状态栏更新 "[X/总数] 文件名"
- ✅ 图像更新显示该文件数据

#### 9.2 前后导航
**操作：**
1. 点击 "⬅ Previous" 或 "Next ➡"

**预期结果：**
- ✅ 切换到上一个/下一个文件
- ✅ 文件列表高亮跟随
- ✅ 到达首尾时不能继续

---

### 10. 结果保存测试

#### 10.1 保存所有结果
**操作：**
1. 拟合至少一个文件
2. 点击 "💾 Save All Results"

**预期结果：**
- ✅ 弹出保存成功对话框
- ✅ 显示保存路径：`[文件夹]/fit_output/batch_fitting_results.csv`
- ✅ 显示处理的文件数和峰数

#### 10.2 检查CSV文件
**操作：**
1. 打开保存的CSV文件

**预期结果：**
- ✅ 文件存在于 `fit_output` 文件夹
- ✅ 包含列：File, Peak, Center, FWHM, Area, Intensity, R_squared
- ✅ 每个峰一行
- ✅ 不同文件间有空行分隔
- ✅ 数据格式正确（6位小数）

---

### 11. 拟合方法切换测试

**操作：**
1. 点击 "Fit Method" 下拉框
2. 选择 "Voigt"

**预期结果：**
- ✅ 下拉框显示 "Voigt"
- ✅ 后续拟合使用Voigt函数

**操作：**
1. 切换回 "Pseudo-Voigt"

**预期结果：**
- ✅ 下拉框显示 "Pseudo-Voigt"
- ✅ 后续拟合使用Pseudo-Voigt函数

---

### 12. 边界情况测试

#### 12.1 没有峰时拟合
**操作：**
1. 清除所有峰（按C键）
2. 点击 "✨ Fit Current"

**预期结果：**
- ✅ 弹出警告 "Please load a file and add peaks first."

#### 12.2 没有文件时Auto Fit
**操作：**
1. 不加载文件
2. 点击 "⚡ Auto Fit"

**预期结果：**
- ✅ 弹出警告 "Please load a folder first."

#### 12.3 空文件夹
**操作：**
1. 选择一个不包含.xy文件的文件夹

**预期结果：**
- ✅ 弹出警告 "No .xy files found in the selected folder."

---

### 13. 性能测试

#### 13.1 大批量文件
**测试数据：** 50-100个.xy文件

**操作：**
1. 加载文件夹
2. 执行Auto Fit

**预期结果：**
- ✅ 文件列表快速填充
- ✅ 文件切换流畅
- ✅ Auto Fit稳定处理所有文件
- ✅ 没有内存泄漏或卡顿

#### 13.2 大数据文件
**测试数据：** 单个文件 > 10,000个数据点

**操作：**
1. 加载大文件
2. 交互操作（添加峰、缩放）
3. 拟合

**预期结果：**
- ✅ 图像绘制流畅
- ✅ 交互响应快速（< 100ms）
- ✅ 拟合速度可接受（< 5秒）

---

### 14. UI测试

#### 14.1 界面布局
**检查项：**
- ✅ 左右分栏比例合理（约1:3）
- ✅ 文件列表可滚动
- ✅ 控制面板高度固定
- ✅ 绘图区域可缩放调整
- ✅ 所有按钮可见且对齐

#### 14.2 视觉效果
**检查项：**
- ✅ 峰标记清晰可见（红色虚线）
- ✅ 背景点清晰可见（浅蓝色方块）
- ✅ 拟合曲线清晰（红色实线，粗）
- ✅ 数据曲线清晰（黑色实线）
- ✅ Overlap模式下颜色区分明显
- ✅ 图表背景色正确（#FAFAFA）

#### 14.3 按钮状态
**检查项：**
- ✅ 选中的模式按钮高亮
- ✅ Overlap按钮显示文件数
- ✅ 按钮悬停效果正常
- ✅ 按钮点击反馈明显

---

### 15. 对比测试（Batch Fit vs Auto Fit）

#### 15.1 启动Auto Fit
**操作：**
1. 点击侧边栏 "🔍 Auto Fit"

**检查：**
- ✅ Auto Fit模块正常显示
- ✅ 与Batch Fit界面不同
- ✅ 两个模块可独立使用

#### 15.2 功能对比
**Batch Fit 独有功能：**
- ✅ 文件列表点击切换
- ✅ Overlap模式
- ✅ 左右分栏布局

**Auto Fit 独有功能：**
- ✅ 验证对话框（Verify mode）
- ✅ batch_summary.csv输出
- ✅ 背景点保留功能更强

---

## 问题排查指南

### 问题1：curvefit按钮仍然可见
**检查：**
```bash
grep -n "curvefit_btn.*sidebar" /workspace/main.py
```
**预期：** 相关行应该被注释（以 # 开头）

---

### 问题2：Batch Fit按钮不显示
**检查：**
```bash
grep -n "Batch Fit" /workspace/main.py
```
**预期：** 应该找到创建和添加按钮的代码

---

### 问题3：点击Batch Fit没有反应
**检查：**
1. 确认 `batch_fitting_module.py` 存在
2. 确认 `batch_fitting_dialog.py` 存在
3. 运行：
```bash
python3 -m py_compile /workspace/batch_fitting_module.py
python3 -m py_compile /workspace/batch_fitting_dialog.py
```

---

### 问题4：加载文件夹后没有文件
**可能原因：**
- 文件夹中没有.xy文件
- 文件扩展名不是.xy

**解决：**
- 确认文件夹包含.xy文件
- 如需支持其他格式，修改 `batch_fitting_dialog.py` line 543

---

### 问题5：拟合失败
**可能原因：**
- 峰位置不准确
- 数据质量差
- 背景点设置不当

**解决：**
1. 手动调整峰位置
2. 增加背景点
3. 尝试切换拟合方法（Voigt ↔ Pseudo-Voigt）

---

## 测试总结表格

| 测试项 | 测试结果 | 备注 |
|-------|---------|------|
| 程序启动 | ⬜ PASS / ❌ FAIL |  |
| Batch Fit按钮显示 | ⬜ PASS / ❌ FAIL |  |
| curvefit按钮隐藏 | ⬜ PASS / ❌ FAIL |  |
| 加载文件夹 | ⬜ PASS / ❌ FAIL |  |
| 添加/删除峰 | ⬜ PASS / ❌ FAIL |  |
| 添加/删除背景点 | ⬜ PASS / ❌ FAIL |  |
| 单文件拟合 | ⬜ PASS / ❌ FAIL |  |
| 自动批量拟合 | ⬜ PASS / ❌ FAIL |  |
| Overlap模式 | ⬜ PASS / ❌ FAIL |  |
| 快捷键功能 | ⬜ PASS / ❌ FAIL |  |
| 缩放功能 | ⬜ PASS / ❌ FAIL |  |
| 文件导航 | ⬜ PASS / ❌ FAIL |  |
| 结果保存 | ⬜ PASS / ❌ FAIL |  |
| CSV格式正确 | ⬜ PASS / ❌ FAIL |  |
| 界面布局 | ⬜ PASS / ❌ FAIL |  |
| 性能测试 | ⬜ PASS / ❌ FAIL |  |

---

## 最小测试流程（快速验证）

如果时间有限，至少测试以下核心功能：

1. ✅ 启动main.py，确认Batch Fit按钮显示，curvefit隐藏
2. ✅ 点击Batch Fit，界面正常显示
3. ✅ 加载一个文件夹
4. ✅ 添加一个峰，按Space拟合
5. ✅ 按Enter进行Auto Fit
6. ✅ 保存结果，检查CSV

如果以上6步全部通过，模块基本功能正常。

---

**测试完成后，请填写上面的测试总结表格，并报告任何问题。**

**文档位置：**
- 详细说明：`模块分离说明_正确版.md`
- 完成总结：`模块重组完成总结_正确版.txt`
- 快速指南：`BATCH_FIT_MODULE_README.md`
