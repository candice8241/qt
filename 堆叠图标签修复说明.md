# 堆叠图标签位置修复说明

## 问题
堆叠图中每条曲线的压力标签位置没有随着offset正确偏移，导致标签不能准确对应各自的曲线。

## 解决方案

### 修改前的问题
```python
# 旧代码
y_pos = y_offset + np.max(data[:, 1]) * 0.3
```

**问题**：标签位置计算使用的是 `0.3`（30%）的峰高，位置偏低，可能重叠或不明显。

### 修改后的改进
```python
# 新代码
peak_height = np.max(data[:, 1])
y_pos = y_offset + peak_height * 0.5  # 50% of peak height
```

**改进**：
1. ✅ **更清晰的变量名** - `peak_height` 更易理解
2. ✅ **更好的位置** - 标签位于峰高的 50%，更醒目
3. ✅ **居中对齐** - 改为 `verticalalignment='center'`，视觉效果更好
4. ✅ **完全随offset移动** - `y_offset + peak_height * 0.5` 确保标签跟随曲线

## 修改的文件

### 1. batch_integration.py
修改了两个堆叠图函数：

#### _create_single_pressure_stacked_plot()
- 用于单一压力下多个扇区的堆叠图
- 标签格式：`"5.0°"`, `"15.0°"` 等（角度值）

#### _create_all_pressure_stacked_plot()
- 用于所有压力点的堆叠图
- 标签格式：`"10.5 GPa"`, `"d38.2 GPa"` 等（压力值，d表示卸压）

### 2. radial_module.py
修改了 `BatchIntegrator` 类中的两个对应方法：
- `_create_single_pressure_stacked_plot()`
- `_create_all_pressure_stacked_plot()`

## 标签位置计算详解

### 原理
堆叠图中，每条曲线的y坐标都被加上了一个offset：

```
curve_i 的 y 坐标 = original_y + i * offset
```

因此，标签的 y 位置必须也加上相同的offset：

```
label_i 的 y 位置 = baseline_offset + relative_height
                  = i * offset + peak_height * 0.5
```

### 示例

假设有3条曲线，offset = 1000：

```
曲线 0: y_offset = 0 * 1000 = 0
  标签位置: 0 + peak_height * 0.5
  
曲线 1: y_offset = 1 * 1000 = 1000  
  标签位置: 1000 + peak_height * 0.5
  
曲线 2: y_offset = 2 * 1000 = 2000
  标签位置: 2000 + peak_height * 0.5
```

这样每个标签都准确地标注在对应曲线的中间高度位置。

## 视觉效果改进

### 修改前
```
曲线3 ──────────
              标签3 (太低)
曲线2 ──────────  
              标签2 (太低，可能重叠)
曲线1 ──────────
              标签1 (太低)
```

### 修改后
```
曲线3 ──────────
        标签3 ← (位于峰高50%，更明显)
曲线2 ──────────  
        标签2 ← (清晰分离)
曲线1 ──────────
        标签1 ← (清晰分离)
```

## 其他改进

### 1. verticalalignment 改为 'center'
```python
# 旧代码
verticalalignment='bottom'  # 底部对齐，标签在y_pos上方

# 新代码  
verticalalignment='center'  # 中心对齐，标签中心在y_pos
```

**好处**：视觉上更平衡，标签不会偏离曲线太远。

### 2. 注释更详细
添加了清晰的注释说明标签位置的计算逻辑：

```python
# Add label - position relative to the baseline + offset
# Position label at 50% of peak height above the baseline (y_offset)
```

## 测试建议

### 测试场景1：不同offset值
- offset = 'auto'（自动）
- offset = 100（小值）
- offset = 5000（大值）

**预期**：标签都应该准确对应各自的曲线，不会重叠或错位。

### 测试场景2：不同曲线数量
- 3条曲线
- 10条曲线
- 20条曲线

**预期**：所有标签都清晰可见，均匀分布。

### 测试场景3：不同峰高
- 所有曲线峰高相似
- 曲线峰高差异很大

**预期**：标签位置相对于各自曲线的峰高都是50%，视觉上保持一致。

## 技术细节

### 为什么选择50%？
- **30%** (旧值) - 太低，容易被曲线基线噪音干扰
- **50%** (新值) - 中间位置，最醒目且不干扰峰顶
- **70%** - 太高，可能干扰峰顶细节

### 为什么用center对齐？
- **bottom** - 标签底部在y_pos，整个标签在上方
- **center** - 标签中心在y_pos，视觉更平衡
- **top** - 标签顶部在y_pos，整个标签在下方

center对齐使得标签文本的中心正好在峰高50%的位置，最符合直觉。

## 总结

✅ 修改完成的功能：
1. 标签位置完全跟随offset变化
2. 标签高度优化为峰高的50%
3. 使用center对齐改善视觉效果
4. 添加详细注释提高代码可维护性

✅ 涉及的文件：
- `batch_integration.py` - 2个函数
- `radial_module.py` - 2个函数

✅ 语法检查：全部通过

现在堆叠图中的压力/角度标签将会准确地标注在对应的曲线上，并随offset完美移动！
