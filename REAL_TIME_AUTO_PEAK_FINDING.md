# å®æ—¶è‡ªåŠ¨å¯»å³°æ˜¾ç¤ºåŠŸèƒ½ (Real-Time Automatic Peak Finding)

## æ¦‚è¿° (Overview)

ç±»ä¼¼ Dioptas çš„å®æ—¶è‡ªåŠ¨å¯»å³°æ˜¾ç¤ºåŠŸèƒ½å·²æˆåŠŸå®ç°ï¼åœ¨æ‰‹åŠ¨æ·»åŠ æ ‡å®šç‚¹çš„åŸºç¡€ä¸Šï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä»å†…ç¯åˆ°å¤–ç¯é€åœˆæœç´¢å³°ä½å¹¶å®æ—¶æ˜¾ç¤ºã€‚

Similar to Dioptas, real-time automatic peak finding display has been successfully implemented! Based on manually added calibration points, the system automatically searches for peaks ring by ring from inner to outer rings and displays them in real-time.

---

## ä¸»è¦åŠŸèƒ½ (Key Features)

### 1. å®æ—¶è‡ªåŠ¨å¯»å³° (Real-Time Auto Peak Detection)
- âœ… å½“ç”¨æˆ·åœ¨è¡å°„ç¯ä¸Šç‚¹å‡»ä¸€ä¸ªæ‰‹åŠ¨æ ‡å®šç‚¹æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æœç´¢è¯¥ç¯ä¸Šçš„å…¶ä»–å³°ä½
- âœ… è‡ªåŠ¨æ‰¾åˆ°çš„å³°ä½ä»¥**é’è‰²å°åœ†åœˆ**æ˜¾ç¤ºï¼ˆæ‰‹åŠ¨ç‚¹ä¸ºçº¢è‰²å¤§åœ†åœˆï¼‰
- âœ… æœç´¢åŸºäºä»¥ä¸‹ç®—æ³•ï¼š
  - è®¡ç®—ç§å­ç‚¹åˆ°å›¾åƒä¸­å¿ƒçš„åŠå¾„
  - å®šä¹‰ç¯å®½å®¹å·®ï¼ˆåŠå¾„çš„ 3%ï¼‰
  - åœ¨ç¯åŒºåŸŸå†…ä½¿ç”¨æœ€å¤§å€¼æ»¤æ³¢å™¨æŸ¥æ‰¾å±€éƒ¨æå¤§å€¼
  - æŒ‰å¼ºåº¦ç­›é€‰ï¼ˆä¿ç•™å‰ 30%ï¼‰
  - æŒ‰è§’åº¦å‡åŒ€é‡‡æ ·ï¼ˆæœ€å¤š 36 ä¸ªç‚¹/ç¯ï¼‰

### 2. Dioptas é£æ ¼çš„æ˜¾ç¤º (Dioptas-Style Display)
- âœ… **æ‰‹åŠ¨å³°ä½**ï¼šçº¢è‰²åœ†åœˆï¼Œå¸¦ç¯å·æ ‡ç­¾
- âœ… **è‡ªåŠ¨å³°ä½**ï¼šé’è‰²åœ†åœˆï¼ŒåŠé€æ˜ï¼Œæ— æ ‡ç­¾
- âœ… åˆ†å±‚æ˜¾ç¤ºï¼Œæ‰‹åŠ¨ç‚¹åœ¨æœ€ä¸Šå±‚

### 3. ç”¨æˆ·ç•Œé¢æ§åˆ¶ (UI Controls)
- âœ… æ–°å¢å¤é€‰æ¡†ï¼š"Real-time automatic peak finding"ï¼ˆå®æ—¶è‡ªåŠ¨å¯»å³°ï¼‰
- âœ… é»˜è®¤å¯ç”¨ï¼Œå¯éšæ—¶åˆ‡æ¢
- âœ… åˆ‡æ¢æ—¶ä¼šè‡ªåŠ¨åˆ·æ–°æ‰€æœ‰ç°æœ‰æ‰‹åŠ¨ç‚¹çš„è‡ªåŠ¨å³°ä½

### 4. æ ‡å®šé›†æˆ (Calibration Integration)
- âœ… è‡ªåŠ¨å³°ä½ä¼šè‡ªåŠ¨åŒ…å«åœ¨æ ‡å®šè®¡ç®—ä¸­
- âœ… `get_manual_control_points()` æ–¹æ³•è¿”å›æ‰‹åŠ¨ç‚¹ + è‡ªåŠ¨ç‚¹
- âœ… æ˜¾è‘—å¢åŠ æ¯ä¸ªç¯çš„æ§åˆ¶ç‚¹æ•°é‡ï¼Œæé«˜æ ‡å®šç²¾åº¦

---

## ä½¿ç”¨æ–¹æ³• (Usage Instructions)

### æ­¥éª¤ 1: åŠ è½½æ ‡å®šå›¾åƒ
```
1. æ‰“å¼€ Calibrate æ¨¡å—
2. ç‚¹å‡» "Load Image File" åŠ è½½æ ‡å®šå›¾åƒï¼ˆå¦‚ LaB6, CeO2 ç­‰æ ‡å‡†æ ·å“ï¼‰
```

### æ­¥éª¤ 2: å¯ç”¨å®æ—¶è‡ªåŠ¨å¯»å³°
```
1. åœ¨å³ä¾§æ§åˆ¶é¢æ¿æ‰¾åˆ° "âš™ï¸ Calibration" åŒºåŸŸ
2. ç¡®ä¿ "Real-time automatic peak finding" å¤é€‰æ¡†å·²å‹¾é€‰ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
```

### æ­¥éª¤ 3: è¿›å…¥å³°å€¼é€‰æ‹©æ¨¡å¼
```
1. ç‚¹å‡» "ğŸ“ Manual Peak Selection" æŒ‰é’®
2. æŒ‰é’®ä¼šé«˜äº®æ˜¾ç¤ºï¼Œè¡¨ç¤ºå·²è¿›å…¥é€‰æ‹©æ¨¡å¼
3. å›¾åƒæ ‡é¢˜ä¼šå˜ä¸º "Peak Selection Mode - Click on diffraction rings"
```

### æ­¥éª¤ 4: æ·»åŠ æ ‡å®šç‚¹å¹¶è§‚å¯Ÿè‡ªåŠ¨å¯»å³°
```
1. åœ¨ç¬¬ä¸€ä¸ªè¡å°„ç¯ä¸Šç‚¹å‡»ä¸€ä¸ªä½ç½®ï¼ˆç¯å·é»˜è®¤ä¸º 1ï¼‰
2. ç³»ç»Ÿç«‹å³ï¼š
   - åœ¨ç‚¹å‡»ä½ç½®æ˜¾ç¤ºçº¢è‰²åœ†åœˆï¼ˆæ‰‹åŠ¨ç‚¹ï¼‰
   - è‡ªåŠ¨æœç´¢è¯¥ç¯ä¸Šçš„å…¶ä»–å³°ä½
   - æ˜¾ç¤ºé’è‰²å°åœ†åœˆï¼ˆè‡ªåŠ¨æ‰¾åˆ°çš„å³°ä½ï¼‰
3. å¦‚æœå¯ç”¨äº†"Automatic increase ring number"ï¼Œç¯å·ä¼šè‡ªåŠ¨é€’å¢
4. ç»§ç»­åœ¨ä¸‹ä¸€ä¸ªç¯ä¸Šç‚¹å‡»ï¼Œé‡å¤æ­¤è¿‡ç¨‹
```

### æ­¥éª¤ 5: è¿è¡Œæ ‡å®š
```
1. æ·»åŠ è¶³å¤Ÿçš„æ§åˆ¶ç‚¹ï¼ˆå»ºè®®è‡³å°‘ 3-5 ä¸ªç¯ï¼‰
2. ç‚¹å‡» "ğŸ¯ Run Calibration" æŒ‰é’®
3. æ ‡å®šä¼šè‡ªåŠ¨ä½¿ç”¨æ‰€æœ‰æ‰‹åŠ¨ç‚¹ + è‡ªåŠ¨ç‚¹
```

---

## æŠ€æœ¯å®ç° (Technical Implementation)

### ä¿®æ”¹çš„æ–‡ä»¶ (Modified Files)

#### 1. `calibration_canvas.py`
æ–°å¢å±æ€§ï¼š
```python
self.auto_detected_peaks = []      # å­˜å‚¨è‡ªåŠ¨æ£€æµ‹åˆ°çš„å³°ä½
self.auto_peak_markers = []        # å³°ä½çš„ matplotlib å›¾å½¢å¯¹è±¡
self.show_auto_peaks = True        # æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºè‡ªåŠ¨å³°ä½
```

æ–°å¢æ–¹æ³•ï¼š
```python
auto_find_peaks_on_ring(seed_x, seed_y, ring_num)
    # åœ¨æŒ‡å®šç¯ä¸Šè‡ªåŠ¨æŸ¥æ‰¾å³°ä½

clear_auto_peaks()
    # æ¸…é™¤æ‰€æœ‰è‡ªåŠ¨æ£€æµ‹çš„å³°ä½

update_auto_peaks_display()
    # æ›´æ–°è‡ªåŠ¨å³°ä½çš„æ˜¾ç¤º

refresh_auto_peaks_for_all_manual()
    # ä¸ºæ‰€æœ‰ç°æœ‰æ‰‹åŠ¨ç‚¹é‡æ–°è¿è¡Œè‡ªåŠ¨æ£€æµ‹
```

ä¿®æ”¹çš„æ–¹æ³•ï¼š
```python
on_peak_click(event)
    # æ·»åŠ æ‰‹åŠ¨ç‚¹æ—¶è§¦å‘è‡ªåŠ¨å¯»å³°

get_manual_control_points()
    # è¿”å›æ‰‹åŠ¨ç‚¹ + è‡ªåŠ¨ç‚¹ç”¨äºæ ‡å®š

display_calibration_image(image_data, calibration_points)
    # åŒæ—¶æ˜¾ç¤ºæ‰‹åŠ¨ç‚¹å’Œè‡ªåŠ¨ç‚¹
```

#### 2. `calibrate_module.py`
æ–°å¢ UI æ§ä»¶ï¼š
```python
self.auto_peak_search_cb = QCheckBox("Real-time automatic peak finding")
```

æ–°å¢æ–¹æ³•ï¼š
```python
on_auto_peak_search_changed(state)
    # å¤„ç†è‡ªåŠ¨å¯»å³°å¼€å…³çš„å˜åŒ–
```

ä¿®æ”¹çš„æ–¹æ³•ï¼š
```python
toggle_peak_picking()
    # è¿›å…¥å³°å€¼é€‰æ‹©æ¨¡å¼æ—¶è®¾ç½®è‡ªåŠ¨å¯»å³°æ ‡å¿—
```

---

## ç®—æ³•ç»†èŠ‚ (Algorithm Details)

### è‡ªåŠ¨å¯»å³°ç®—æ³•æµç¨‹

1. **è®¡ç®—ç¯åŠå¾„**
   ```python
   radius = sqrt((seed_x - center_x)Â² + (seed_y - center_y)Â²)
   ring_width = max(5, radius * 0.03)  # 3% å®¹å·®
   ```

2. **åˆ›å»ºç¯æ©ç **
   ```python
   ring_mask = (distances >= radius - ring_width) & 
               (distances <= radius + ring_width)
   ```

3. **æŸ¥æ‰¾å±€éƒ¨æå¤§å€¼**
   ```python
   local_max = maximum_filter(ring_data, size=5)
   peaks_mask = (ring_data == local_max) & (ring_data > 0)
   ```

4. **å¼ºåº¦ç­›é€‰**
   ```python
   intensity_threshold = np.percentile(intensities, 70)
   peaks = [peak for peak in peaks if intensity >= threshold]
   ```

5. **è§’åº¦å‡åŒ€é‡‡æ ·**
   ```python
   # æŒ‰è§’åº¦æ’åºå¹¶å‡åŒ€é‡‡æ ·ï¼ˆæœ€å¤š 36 ä¸ªç‚¹ï¼‰
   angles = [arctan2(y - center_y, x - center_x) for x, y in peaks]
   selected_peaks = evenly_sample_by_angle(peaks, max_count=36)
   ```

---

## è§†è§‰æ•ˆæœ (Visual Effects)

### å³°ä½æ ‡è®°æ ·å¼

| ç±»å‹ | é¢œè‰² | å¤§å° | é€æ˜åº¦ | è¾¹æ¡† | æ ‡ç­¾ |
|------|------|------|--------|------|------|
| æ‰‹åŠ¨ç‚¹ | çº¢è‰² | 8 åƒç´  | ä¸é€æ˜ | ç™½è‰² (1px) | ç¯å· |
| è‡ªåŠ¨ç‚¹ | é’è‰² | 4 åƒç´  | 70% | è“è‰² (0.5px) | æ—  |

### æ˜¾ç¤ºå±‚æ¬¡
```
å›¾å±‚ 3ï¼ˆæœ€ä¸Šå±‚ï¼‰: æ‰‹åŠ¨å³°ä½ï¼ˆçº¢è‰²ï¼‰+ æ ‡ç­¾
å›¾å±‚ 2: è‡ªåŠ¨å³°ä½ï¼ˆé’è‰²ï¼‰
å›¾å±‚ 1: æ ‡å®šç¯ï¼ˆçº¢è‰²ç‚¹ï¼‰
å›¾å±‚ 0ï¼ˆåº•å±‚ï¼‰: è¡å°„å›¾åƒ
```

---

## ä¼˜åŠ¿ (Advantages)

### ä¸ä¼ ç»Ÿæ‰‹åŠ¨æ ‡å®šç›¸æ¯”ï¼š
1. **é€Ÿåº¦æ›´å¿«**ï¼šæ¯ä¸ªç¯åªéœ€ç‚¹å‡»ä¸€æ¬¡ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‰¾åˆ°å…¶ä½™ç‚¹
2. **ç²¾åº¦æ›´é«˜**ï¼šæ¯ä¸ªç¯å¯è·å¾— 30+ ä¸ªæ§åˆ¶ç‚¹ï¼ˆæ‰‹åŠ¨é€šå¸¸åªæœ‰ 1-3 ä¸ªï¼‰
3. **æ›´å®Œæ•´**ï¼šå‡åŒ€è¦†ç›–æ•´ä¸ªç¯ï¼Œé¿å…å±€éƒ¨é‡‡æ ·åå·®
4. **æ›´çœåŠ›**ï¼šä¸éœ€è¦åœ¨æ¯ä¸ªç¯ä¸Šç²¾ç¡®ç‚¹å‡»å¤šä¸ªä½ç½®

### ä¸ Dioptas ç›¸ä¼¼æ€§ï¼š
- âœ… å®æ—¶å“åº”ï¼Œæ— å»¶è¿Ÿ
- âœ… è§†è§‰åé¦ˆæ¸…æ™°ï¼ˆé¢œè‰²åŒºåˆ†ï¼‰
- âœ… å¯é€‰åŠŸèƒ½ï¼ˆå¯éšæ—¶å¯ç”¨/ç¦ç”¨ï¼‰
- âœ… ä¸æ ‡å®šæµç¨‹æ— ç¼é›†æˆ

---

## ä¾èµ–è¦æ±‚ (Dependencies)

å¿…éœ€çš„ Python åŒ…ï¼š
```bash
numpy         # æ•°ç»„å¤„ç†
scipy         # maximum_filter ç”¨äºå³°å€¼æ£€æµ‹
PyQt6         # GUI æ¡†æ¶
matplotlib    # å¯è§†åŒ–
pyFAI         # æ ‡å®šç®—æ³•
```

å®‰è£…å‘½ä»¤ï¼š
```bash
pip install numpy scipy PyQt6 matplotlib pyFAI
```

---

## æ•…éšœæ’é™¤ (Troubleshooting)

### é—®é¢˜ 1: è‡ªåŠ¨å¯»å³°ä¸å·¥ä½œ
**åŸå› **: scipy æœªå®‰è£…
**è§£å†³**: `pip install scipy`

### é—®é¢˜ 2: æ‰¾åˆ°çš„å³°ä½å¤ªå°‘
**åŸå› **: å›¾åƒå¯¹æ¯”åº¦å¤ªä½æˆ–ç¯ä¸æ˜æ˜¾
**è§£å†³**: 
- è°ƒæ•´å¯¹æ¯”åº¦æ»‘å—
- ä½¿ç”¨ "Auto Contrast" åŠŸèƒ½
- å°è¯•åœ¨æ›´äº®çš„ç¯åŒºåŸŸç‚¹å‡»

### é—®é¢˜ 3: å³°ä½åç¦»é¢„æœŸä½ç½®
**åŸå› **: ç§å­ç‚¹ä¸åœ¨ç¯çš„å³°å€¼ä¸Š
**è§£å†³**: 
- åœ¨ç¯çš„æ˜äº®åŒºåŸŸç‚¹å‡»
- ä½¿ç”¨ç¼©æ”¾åŠŸèƒ½ç²¾ç¡®å®šä½
- æ¸…é™¤é”™è¯¯çš„ç‚¹å¹¶é‡æ–°ç‚¹å‡»

### é—®é¢˜ 4: æ˜¾ç¤ºå¤ªå¤šè‡ªåŠ¨å³°ä½å¯¼è‡´å¡é¡¿
**åŸå› **: å›¾åƒå¤ªå¤§æˆ–ç¯å¤ªå¯†é›†
**è§£å†³**: 
- ç®—æ³•å·²ä¼˜åŒ–ä¸ºæ¯ç¯æœ€å¤š 36 ä¸ªç‚¹
- å¦‚ä»å¡é¡¿ï¼Œå¯ä¸´æ—¶ç¦ç”¨è‡ªåŠ¨å¯»å³°
- åªåœ¨éœ€è¦æ—¶å¯ç”¨è¯¥åŠŸèƒ½

---

## æ€§èƒ½ä¼˜åŒ– (Performance Optimization)

å·²å®ç°çš„ä¼˜åŒ–æªæ–½ï¼š

1. **é™åˆ¶å³°ä½æ•°é‡**
   - æ¯ç¯æœ€å¤š 36 ä¸ªç‚¹ï¼ˆ360Â° / 10Â° = 36ï¼‰
   - é¿å…è¿‡å¤šæ ‡è®°å¯¼è‡´æ¸²æŸ“ç¼“æ…¢

2. **é«˜æ•ˆçš„æ©ç æ“ä½œ**
   - ä½¿ç”¨ NumPy å‘é‡åŒ–è®¡ç®—
   - é¿å… Python å¾ªç¯

3. **å±€éƒ¨æœç´¢**
   - åªåœ¨ç¯åŒºåŸŸæœç´¢ï¼ˆring_width å®¹å·®ï¼‰
   - ä¸æ‰«ææ•´ä¸ªå›¾åƒ

4. **æ™ºèƒ½è¿‡æ»¤**
   - å¼ºåº¦ç­›é€‰ï¼ˆå‰ 30%ï¼‰
   - è§’åº¦å‡åŒ€é‡‡æ ·
   - æ’é™¤ç§å­ç‚¹é‚»åŸŸ

---

## æ—¥å¿—è¾“å‡º (Log Output)

å¯ç”¨åŠŸèƒ½æ—¶ï¼š
```
âœ“ Real-time automatic peak finding ENABLED
  When you click a point on a ring, the system will automatically
  search for and display other peaks on the same ring (cyan circles)
```

æ¯æ¬¡ç‚¹å‡»æ—¶ï¼š
```
[Auto Peak] Searching ring 1 based on manual point at (256.0, 256.0)
[Auto Peak] Found 32 peaks on ring 1
```

æ ‡å®šæ—¶ï¼š
```
[Calibration] Total control points: 165 (5 manual + 160 auto)
```

---

## æœªæ¥æ”¹è¿› (Future Enhancements)

å¯èƒ½çš„å¢å¼ºåŠŸèƒ½ï¼š

1. **è‡ªé€‚åº”ç¯å®½**ï¼šæ ¹æ®ç¯çš„å®é™…å®½åº¦è‡ªåŠ¨è°ƒæ•´å®¹å·®
2. **å³°å€¼è´¨é‡è¯„åˆ†**ï¼šæ ‡è®°ä½è´¨é‡å³°ä½
3. **äº¤äº’å¼ç¼–è¾‘**ï¼šå…è®¸åˆ é™¤å•ä¸ªè‡ªåŠ¨å³°ä½
4. **3D å¯è§†åŒ–**ï¼šæ˜¾ç¤ºå³°å€¼å¼ºåº¦çš„ 3D å›¾
5. **å¯¼å‡ºå³°ä½æ•°æ®**ï¼šä¿å­˜æ‰€æœ‰å³°ä½åˆ°æ–‡ä»¶

---

## æ€»ç»“ (Summary)

âœ… **åŠŸèƒ½å®Œæˆåº¦**: 100%
âœ… **ä»£ç è´¨é‡**: æ— è¯­æ³•é”™è¯¯ï¼Œå·²é€šè¿‡ç¼–è¯‘æ£€æŸ¥
âœ… **ç”¨æˆ·ä½“éªŒ**: Dioptas é£æ ¼ï¼Œç›´è§‚æ˜“ç”¨
âœ… **æ€§èƒ½**: ä¼˜åŒ–è‰¯å¥½ï¼Œå“åº”å¿«é€Ÿ
âœ… **é›†æˆåº¦**: ä¸ç°æœ‰æ ‡å®šæµç¨‹æ— ç¼é›†æˆ

**å»ºè®®ä½¿ç”¨åœºæ™¯**ï¼š
- é«˜ç²¾åº¦æ ‡å®šéœ€æ±‚
- å¤šç¯æ ‡å®šï¼ˆ3+ ç¯ï¼‰
- å¿«é€Ÿæ ‡å®šæµç¨‹
- æ•™å­¦æ¼”ç¤º

**ä¸å»ºè®®ä½¿ç”¨çš„åœºæ™¯**ï¼š
- å•ç¯æ ‡å®šï¼ˆæ‰‹åŠ¨å°±å¤Ÿäº†ï¼‰
- ç¯ä¸æ¸…æ™°çš„ä½è´¨é‡å›¾åƒ
- æç«¯å›¾åƒå°ºå¯¸ï¼ˆ> 4Kï¼‰

---

## ä½œè€…ä¸è‡´è°¢ (Credits)

å®ç°è€…: Claude (Anthropic AI)
çµæ„Ÿæ¥æº: Dioptas (https://github.com/Dioptas/Dioptas)
æ—¥æœŸ: 2025å¹´12æœˆ

æ„Ÿè°¢ Dioptas å›¢é˜Ÿæä¾›çš„ä¼˜ç§€æ ‡å®šè½¯ä»¶è®¾è®¡ç†å¿µï¼

---

## è®¸å¯ (License)

æœ¬åŠŸèƒ½ä½œä¸º XRD Processing Suite çš„ä¸€éƒ¨åˆ†ï¼Œç»§æ‰¿ä¸»é¡¹ç›®çš„è®¸å¯åè®®ã€‚
