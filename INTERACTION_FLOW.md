# H5 Preview Dialog & Powder Module äº¤äº’æµç¨‹å›¾

## æ•´ä½“äº¤äº’æµç¨‹ (Overall Interaction Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Powder XRD Module                          â”‚
â”‚                     (powder_module.py)                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Integration Settings Section                   â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  PONI File:        [________________] [Browse]         â”‚   â”‚
â”‚  â”‚  Mask File:        [________________] [Browse]         â”‚   â”‚
â”‚  â”‚  Input Pattern:    [________________] [Browse]         â”‚   â”‚
â”‚  â”‚  Output Directory: [________________] [Browse]         â”‚   â”‚
â”‚  â”‚  Dataset Path:     [________________] [Browse]         â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  Sector Integration (Optional):                        â”‚   â”‚
â”‚  â”‚  [ğŸ” H5 Preview & Select Region] â—„â”€â”€ ç‚¹å‡»æ‰“å¼€å¯¹è¯æ¡†   â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  âœ“ Sector selected: Azim [0.0Â° - 90.0Â°], ...          â”‚   â”‚
â”‚  â”‚     (æ˜¾ç¤ºé€‰ä¸­çš„æ‰‡å½¢å‚æ•°)                               â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚              [Run Integration]                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ ç‚¹å‡»"H5 Preview"æŒ‰é’®
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   H5 Preview Dialog                             â”‚
â”‚                 (h5_preview_dialog.py)                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [ğŸ“‚ Load H5] | Azim: [0] - [90]Â° | Radial: [0] - [0]pxâ”‚   â”‚
â”‚  â”‚                                           [ğŸ¯ Draw]      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Image Preview                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚         [è¡å°„å›¾åƒæ˜¾ç¤ºï¼Œå¸¦æ‰‡å½¢åŒºåŸŸå åŠ ]                  â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚         Position: (x, y)  Radial: xxx px               â”‚   â”‚
â”‚  â”‚         Azimuth: xxx.xÂ°                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚          [âœ“ Use for Integration]  [Close]                      â”‚
â”‚                    â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ ç‚¹å‡»"Use for Integration"
                     â–¼
              è¿”å›æ‰‡å½¢å‚æ•°åˆ° Powder Module
                {
                  'h5_file': '...',
                  'azim_start': 0.0,
                  'azim_end': 90.0,
                  'rad_min': 0.0,
                  'rad_max': 0.0,
                  'center_x': 1024,
                  'center_y': 1024
                }
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Powder Module å¤„ç†                             â”‚
â”‚                                                                 â”‚
â”‚  1. å­˜å‚¨æ‰‡å½¢å‚æ•°åˆ° self.sector_params                           â”‚
â”‚  2. æ›´æ–°ç•Œé¢æ˜¾ç¤ºé€‰ä¸­çš„å‚æ•°                                      â”‚
â”‚  3. è‡ªåŠ¨å¡«å……è¾“å…¥æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰                          â”‚
â”‚  4. è®°å½•åˆ°æ—¥å¿—                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ ç”¨æˆ·ç‚¹å‡»"Run Integration"
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Integration Process ç§¯åˆ†å¤„ç†                        â”‚
â”‚                                                                 â”‚
â”‚  1. æ£€æŸ¥æ‰‡å½¢å‚æ•°æ˜¯å¦å­˜åœ¨                                        â”‚
â”‚  2. å¦‚æœå­˜åœ¨ï¼Œè½¬æ¢è§’åº¦ï¼ˆåº¦ â†’ å¼§åº¦ï¼‰                             â”‚
â”‚  3. æ„å»º sector_kwargs = {                                     â”‚
â”‚       'azimuth_range': (start_rad, end_rad)                    â”‚
â”‚     }                                                           â”‚
â”‚  4. åˆ›å»ºç§¯åˆ†å­è¿›ç¨‹è„šæœ¬ï¼Œä¼ é€’ sector_kwargs                      â”‚
â”‚  5. æ‰§è¡Œç§¯åˆ†                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Batch Integration æ‰¹å¤„ç†ç§¯åˆ†                          â”‚
â”‚                (batch_integration.py)                           â”‚
â”‚                                                                 â”‚
â”‚  run_batch_integration(                                        â”‚
â”‚      ...,                                                      â”‚
â”‚      sector_kwargs={'azimuth_range': (0, Ï€/2)}                â”‚
â”‚  )                                                             â”‚
â”‚                                                                 â”‚
â”‚  â”œâ”€â–º BatchIntegrator.batch_integrate()                        â”‚
â”‚       â”œâ”€â–º integrate_single()                                   â”‚
â”‚            â””â”€â–º ai.integrate1d(                                 â”‚
â”‚                    data,                                        â”‚
â”‚                    azimuth_range=(start, end),  â—„â”€â”€ æ‰‡åŒºå‚æ•°   â”‚
â”‚                    ...                                          â”‚
â”‚                )                                                â”‚
â”‚                                                                 â”‚
â”‚  â””â”€â–º ç”Ÿæˆè¾“å‡ºæ–‡ä»¶ (.xy, .dat, ç­‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è¯¦ç»†æ­¥éª¤è¯´æ˜ (Detailed Step-by-Step)

### Step 1: ç”¨æˆ·æ“ä½œ - æ‰“å¼€ H5 é¢„è§ˆ
```
ç”¨æˆ·åœ¨ Powder Module ä¸­
  â†“
ç‚¹å‡» "ğŸ” H5 Preview & Select Region" æŒ‰é’®
  â†“
powder_module.open_h5_preview() è¢«è°ƒç”¨
  â†“
åˆ›å»º H5PreviewDialog å®ä¾‹
  â†“
å¯¹è¯æ¡†æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ H5 æ–‡ä»¶ï¼Œè‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªï¼‰
```

### Step 2: é€‰æ‹©æ‰‡å½¢åŒºåŸŸ
```
åœ¨ H5 é¢„è§ˆå¯¹è¯æ¡†ä¸­
  â†“
ç”¨æˆ·åŠ è½½ H5 å›¾åƒï¼ˆå¦‚æœéœ€è¦ï¼‰
  â†“
ç”¨æˆ·è®¾ç½®æ‰‡å½¢å‚æ•°ï¼š
  - Azimuth: 0Â° - 90Â°
  - Radial: 0 - auto
  â†“
ç‚¹å‡» "Draw" æŒ‰é’®å¯è§†åŒ–æ‰‡å½¢
  â†“
ç¡®è®¤é€‰æ‹©ï¼Œç‚¹å‡» "âœ“ Use for Integration"
  â†“
h5_preview_dialog.use_for_integration() è¢«è°ƒç”¨
  â†“
éªŒè¯å‚æ•°ï¼Œè°ƒç”¨ accept()
  â†“
å¯¹è¯æ¡†å…³é—­ï¼Œè¿”å›åˆ° Powder Module
```

### Step 3: å‚æ•°ä¼ é€’å› Powder Module
```
å¯¹è¯æ¡† exec() è¿”å› Accepted
  â†“
powder_module.open_h5_preview() ç»§ç»­æ‰§è¡Œ
  â†“
è°ƒç”¨ dialog.get_sector_parameters()
  â†“
è·å–æ‰‡å½¢å‚æ•°å­—å…¸
  â†“
å­˜å‚¨åˆ° self.sector_params
  â†“
æ›´æ–°ç•Œé¢æ˜¾ç¤º
  â†“
è®°å½•åˆ°æ—¥å¿—
  â†“
è‡ªåŠ¨å¡«å……è¾“å…¥æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

### Step 4: è¿è¡Œç§¯åˆ†
```
ç”¨æˆ·è®¾ç½®å…¶ä»–ç§¯åˆ†å‚æ•°
  â†“
ç‚¹å‡» "Run Integration" æŒ‰é’®
  â†“
powder_module.run_integration() è¢«è°ƒç”¨
  â†“
æ£€æŸ¥ self.sector_params æ˜¯å¦å­˜åœ¨
  â†“
å¦‚æœå­˜åœ¨ï¼š
  - è½¬æ¢è§’åº¦ï¼ˆåº¦ â†’ å¼§åº¦ï¼‰
  - åˆ›å»º sector_kwargs
  â†“
ç”Ÿæˆç§¯åˆ†è„šæœ¬ï¼ˆåŒ…å« sector_kwargsï¼‰
  â†“
å¯åŠ¨å­è¿›ç¨‹æ‰§è¡Œç§¯åˆ†
  â†“
batch_integration.run_batch_integration() åœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œ
  â†“
å°† sector_kwargs åˆå¹¶åˆ° integration_kwargs
  â†“
è°ƒç”¨ BatchIntegrator.batch_integrate()
  â†“
å¯¹æ¯ä¸ª H5 æ–‡ä»¶ï¼š
  - è¯»å–å›¾åƒ
  - è°ƒç”¨ ai.integrate1d(..., azimuth_range=..., ...)
  - ä¿å­˜ç»“æœ
  â†“
ç§¯åˆ†å®Œæˆ
  â†“
è¿”å›ç»“æœåˆ° GUI
  â†“
æ›´æ–°è¿›åº¦æ¡å’Œæ—¥å¿—
```

## æ•°æ®æµ (Data Flow)

```
H5PreviewDialog                 PowderModule                BatchIntegration
     â”‚                               â”‚                            â”‚
     â”‚  get_sector_parameters()      â”‚                            â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚    {azim_start, azim_end,...} â”‚                            â”‚
     â”‚                               â”‚                            â”‚
     â”‚                               â”‚  sector_kwargs             â”‚
     â”‚                               â”‚  {azimuth_range=(r1,r2)}   â”‚
     â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                               â”‚                            â”‚
     â”‚                               â”‚                            â”œâ”€> pyFAI
     â”‚                               â”‚                            â”‚   integrate1d
     â”‚                               â”‚                            â”‚
     â”‚                               â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                               â”‚     Integration Results    â”‚
     â”‚                               â”‚                            â”‚
```

## å…³é”®ä»£ç è°ƒç”¨é“¾ (Key Code Call Chain)

### 1. æ‰“å¼€å¯¹è¯æ¡†
```python
powder_module.py:
  open_h5_preview()
    â”œâ”€> dialog = H5PreviewDialog(initial_file=...)
    â”œâ”€> result = dialog.exec()
    â””â”€> if result == Accepted:
          â””â”€> sector_params = dialog.get_sector_parameters()
```

### 2. æ‰§è¡Œç§¯åˆ†
```python
powder_module.py:
  run_integration()
    â”œâ”€> if sector_params:
    â”‚     â””â”€> sector_kwargs = {'azimuth_range': (rad1, rad2)}
    â””â”€> _create_integration_script(sector_kwargs=sector_kwargs)
          â””â”€> run_batch_integration(..., sector_kwargs=...)

batch_integration.py:
  run_batch_integration(sector_kwargs=...)
    â”œâ”€> integration_kwargs.update(sector_kwargs)
    â””â”€> batch_integrate(..., **integration_kwargs)
          â””â”€> integrate_single(..., **kwargs)
                â””â”€> ai.integrate1d(..., azimuth_range=...)
```

## ç”¨æˆ·ç•Œé¢å˜åŒ– (UI Changes)

### åˆå§‹çŠ¶æ€ï¼ˆæ— æ‰‡å½¢é€‰æ‹©ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sector Integration (Optional):          â”‚
â”‚ [ğŸ” H5 Preview & Select Region]         â”‚
â”‚ No sector selected (full integration)   â”‚ â—„â”€â”€ ç°è‰²æ–‡å­—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é€‰æ‹©æ‰‡å½¢å
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sector Integration (Optional):          â”‚
â”‚ [ğŸ” H5 Preview & Select Region]         â”‚
â”‚ âœ“ Sector selected: Azim [0.0Â° - 90.0Â°],â”‚ â—„â”€â”€ ç»¿è‰²åŠ ç²—
â”‚   Radial [0.0 - auto px]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**æ€»ç»“**: è¿™ä¸ªäº¤äº’æµç¨‹å®ç°äº†ä»å¯è§†åŒ–é€‰æ‹©åˆ°è‡ªåŠ¨åº”ç”¨çš„å®Œæ•´å·¥ä½œæµï¼Œç”¨æˆ·å‹å¥½ä¸”çµæ´»ã€‚
