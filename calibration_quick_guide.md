# 标定快速指南

## 🎯 快速开始

### 基础标定（5分钟）

```
1. Load Image File
   ├─ 选择标定图像（TIF/CBF/...）
   └─ 图像自动显示

2. Set Parameters
   ├─ Calibrant: LaB6
   ├─ Wavelength: 0.4133 Å
   ├─ Distance: 500 mm
   └─ Pixel Size: 172 μm

3. Peak Selection
   ├─ 选择 "Manual Peak Selection"
   ├─ 在图像上点击峰位
   ├─ 至少标记 3 个环
   └─ 每环 6-8 个点（均匀分布）

4. Refinement Preset
   └─ 点击 "Basic (Dist + Center)"
      默认精修：距离 + 光束中心
      不精修：探测器倾斜 + 波长

5. Run Calibration
   ├─ 点击 "🎯 Run Calibration"
   ├─ 观察日志输出
   └─ 等待完成（10-30秒）

6. Check Result
   ├─ 切换到 "Cake" 标签
   ├─ 检查白线是否为直线 ✓
   └─ 查看 RMS 误差（目标 < 1.0 px）

7. Save PONI
   └─ 点击 "💾 Save PONI"
```

---

## ⚙️ 参数说明

### Search Size（搜索半径）

**默认值：1 像素**

| 值 | 搜索区域 | 适用情况 |
|----|---------|---------|
| 1  | 3×3     | 锐利的峰（推荐）|
| 2  | 5×5     | 略微模糊的峰 |
| 3  | 7×7     | 较宽的峰 |
| 4+ | 9×9+    | 很宽的峰（不推荐）|

**原则：尽量用小值，确保精度！**

---

### Refinement Parameters（精修参数）

#### 预设选项

**Basic (Dist + Center)** — 推荐 ⭐⭐⭐
```
精修: Distance, PONI1, PONI2
固定: Rot1, Rot2, Rot3, Wavelength

适用: 探测器垂直于光束（大多数情况）
优点: 稳定、快速、准确
```

**Full (+ Tilt)** — 高级用户
```
精修: Distance, PONI1, PONI2, Rot1, Rot2, Rot3
固定: Wavelength

适用: 探测器有倾斜
要求: ≥50 控制点，≥4 个环
注意: 可能不稳定，系统会自动验证
```

#### 手动选择

可以单独勾选每个参数：
- ✅ Distance（必须）
- ✅ Beam Center Y（必须）
- ✅ Beam Center X（必须）
- ☐ Rot1（倾斜1）
- ☐ Rot2（倾斜2）
- ☐ Rot3（平面旋转）
- ☐ Wavelength（通常固定）

---

## 📊 质量标准

### RMS 误差评估

| RMS 误差 | 质量 | 操作建议 |
|---------|------|---------|
| < 0.5 px | ★★★ 极好 | 完美！可以保存 |
| 0.5-1.0 px | ★★ 良好 | 很好，可以使用 |
| 1.0-2.0 px | ★ 可接受 | 可用，但可以改进 |
| > 2.0 px | ⚠ 较差 | 需要重新标定 |

### Cake 视图检查

**标定正确的标志：**
```
白色标定线 = 垂直直线
     |    |    |    |
     |    |    |    |
     |    |    |    |
```

**标定错误的标志：**
```
白色标定线 = 弯曲
     /    \    /    \
    /      \  /      \
   /        \/        \
```

---

## 🔧 故障排除

### 问题 1: 每次结果都不一样

**原因：**
- Search Size 太大
- 控制点太少
- 控制点分布不均

**解决：**
```
1. Search Size 改为 1
2. 增加控制点到 ≥30
3. 确保每个环都有点
4. 点要均匀分布（0°, 45°, 90°, ...）
```

---

### 问题 2: Cake 的线是弯的

**原因：**
标定参数不准确

**解决：**
```
1. 检查初始参数（distance, pixel size）
2. 增加控制点数量（≥50）
3. 尝试 "Full" 预设
4. 检查 calibrant 和 wavelength 是否正确
```

---

### 问题 3: RMS 误差 > 2.0 px

**改进步骤：**
```
1. 添加更多控制点（目标: 50+）
2. 包含更多环（至少 4 个）
3. 特别关注外环（高分辨率）
4. 使用 "Full" 预设（精修倾斜）
5. 验证所有输入参数
```

---

### 问题 4: 找不到足够的峰

**解决：**
```
1. 增加 Search Size（2, 3, 4）
2. 调整图像对比度
3. 切换到 Manual Peak Selection
4. 手动标记峰位
```

---

## 💡 最佳实践

### 控制点选择

**数量要求：**
```
最少: 10 个点（3 个环）
推荐: 30 个点（3-4 个环）
理想: 50+ 个点（4-5 个环）
```

**分布要求：**
```
每个环: 6-10 个点
方位角: 均匀分布（每 45° 一个点）
环选择: 包含内环和外环
```

**标记技巧：**
```
1. 选择清晰、强度高的峰
2. 避免重叠或模糊的区域
3. 避免探测器边缘
4. 在 Mask 区域外标记
```

---

### 参数设置

**初始值很重要！**

```python
# 好的初始值 → 快速收敛
Distance: 实际测量值 ± 10%
Beam Center: 探测器中心 ± 5%
Pixel Size: 精确值（查探测器规格）
Wavelength: 精确值（查光源参数）

# 差的初始值 → 可能不收敛
Distance: 随便猜一个
Beam Center: 偏差太大
Pixel Size: 错误
Wavelength: 不准确
```

---

### 精修顺序

**推荐工作流：**

```
Step 1: Basic 预设 + 少量控制点（快速测试）
        ├─ 检查 RMS
        └─ 检查 Cake 是否基本正确

Step 2: Basic 预设 + 更多控制点（精细标定）
        ├─ 目标 RMS < 1.0 px
        └─ Cake 线应为直线

Step 3: (可选) Full 预设（探测器有倾斜）
        ├─ 只在 Basic 不够好时使用
        ├─ 需要 ≥50 控制点
        └─ 检查旋转角度是否合理（< 5°）
```

---

## 📖 Console 输出

### 正常运行

**无输出** ✓

程序正常运行时，console 保持干净。
所有进度信息显示在 GUI 日志框中。

### 报错时

```
ERROR loading image: File not found
ERROR in Cake view: Invalid AI object
ERROR creating CalibrationCanvas: ...
```

只有错误信息会输出到 console。

---

## 🎓 理解精修过程

### 什么是非线性最小二乘法？

**简单理解：**
```
目标: 找到最佳几何参数，使得
      理论峰位 ≈ 观测峰位

方法: 迭代优化
      1. 计算当前参数下的理论峰位
      2. 与观测峰位比较
      3. 调整参数使误差减小
      4. 重复直到收敛

输出: RMS 误差（均方根误差）
```

### 为什么要分步精修？

**原因：**
```
一次性精修所有参数 → 可能不稳定
分步精修 → 更稳定

Stage 1: 距离 + 光束中心（最重要）
         ↓
Stage 2: 探测器倾斜（如果需要）
         ↓
Stage 3: 波长（极少需要）
```

### 权重是什么？

**作用：**
```
不同的控制点对精修的贡献不同

高权重 = 重要，精修时更关注
低权重 = 不太重要

策略:
- 外环的点 → 高权重（角度分辨率好）
- 点少的环 → 高权重（平衡贡献）
- 点多的环 → 低权重（避免主导）
```

---

## 🚀 高级技巧

### 技巧 1: 快速迭代

```
1. 用自动峰搜索快速得到初步结果
2. 检查 Cake 和 RMS
3. 如果不满意，切换到 Manual 模式
4. 在问题区域添加更多控制点
5. 重新 Calibrate
```

### 技巧 2: 验证标定

```
标定后验证:
1. Cake 视图: 线必须是直的
2. Pattern 视图: 峰位与红线对齐
3. RMS < 1.0 px
4. 旋转角度（如果精修）< 3°
```

### 技巧 3: 处理倾斜探测器

```
如果探测器确实有倾斜:
1. 确保 ≥50 控制点
2. 使用 "Full" 预设
3. 检查旋转角度是否合理
4. 如果角度 > 5°，可能有问题
5. 验证 RMS 是否改善 ≥2%
```

---

## 📚 参考资料

**pyFAI 文档:**
- https://pyfai.readthedocs.io/

**Dioptas 项目:**
- https://github.com/Dioptas/Dioptas

**标定理论:**
- 搜索 "X-ray detector calibration"
- 搜索 "pyFAI geometry refinement"

---

## ✅ 检查清单

### 标定前

- [ ] 加载了正确的标定图像
- [ ] Calibrant 选择正确
- [ ] Wavelength 准确
- [ ] Distance 接近真实值
- [ ] Pixel Size 准确

### 标定中

- [ ] Search Size = 1（或根据峰形状调整）
- [ ] 至少 30 个控制点
- [ ] 至少 3-4 个环
- [ ] 控制点均匀分布
- [ ] 选择了合适的精修预设

### 标定后

- [ ] RMS < 1.0 px
- [ ] Cake 视图的线是直的
- [ ] Pattern 视图峰位正确
- [ ] 旋转角度合理（如果精修）
- [ ] 保存了 PONI 文件

---

**提示：遇到问题时，优先检查 Search Size 和控制点数量！**

**更新日期**: 2025年12月5日
