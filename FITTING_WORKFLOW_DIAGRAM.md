# 峰拟合工作流程图示

## 改进前的流程

```
检测峰位置
    ↓
判断是否重叠
    ↓
├─ 单峰 → 单独拟合 → 绘制红色曲线
│
└─ 多峰 → 直接联合拟合 → 绘制总和红色曲线
         (使用简单初始猜测)
```

**问题：**
- 多峰拟合初始值不够准确
- 容易陷入局部最优
- 无法看到各峰的独立贡献

---

## 改进后的流程

```
检测峰位置
    ↓
判断是否重叠
    ↓
├─ 单峰 → 单独拟合 → 绘制红色实线
│         (最优参数)
│
└─ 多峰 → 三步优化策略
          │
          ├─ Step 1: 单独拟合每个峰
          │   ├─ 峰1: 独立拟合 → 参数P1
          │   ├─ 峰2: 独立拟合 → 参数P2  
          │   └─ 峰3: 独立拟合 → 参数P3
          │   (绘制：浅粉色虚线)
          │
          ├─ Step 2: 联合多峰拟合
          │   使用 P1, P2, P3 作为初始值
          │   → 优化得到 P1', P2', P3'
          │   (绘制：深粉红色虚线 - 各峰分量)
          │
          └─ Step 3: 绘制总和
              P1' + P2' + P3' = 总拟合曲线
              (绘制：红色连续实线)
```

---

## 绘图层次展示

### 单峰区域：
```
原始数据 ━━━━━━ (黑色)
拟合曲线 ━━━━━━ (红色实线)
峰标记   ✚      (红色十字)
```

### 多峰重叠区域：
```
原始数据 ━━━━━━━━━━━━━━━━ (黑色)
         ╱╲    ╱╲    ╱╲
初始拟合 ┄┄┄┄┄┄┄┄┄┄┄┄┄┄ (浅粉虚线) - 单独拟合
各峰分量 ╌╌╌╌╌╌╌╌╌╌╌╌╌╌ (深粉虚线) - 优化后分量
总和拟合 ━━━━━━━━━━━━━━━━ (红色实线) - 最终结果
峰标记   ✚      ✚      ✚  (红色十字)
```

---

## 参数存储结构

### 单峰参数：
```python
{
    'amplitude': 1234.5,
    'center': 28.345,
    'sigma': 0.0234,
    'gamma': 0.0198,
    'eta': 0.5,
    'is_multi_peak': False
}
```

### 多峰参数（每个峰）：
```python
{
    # 多峰优化的最终参数（用于表格显示和计算）
    'amplitude': 1234.5,
    'center': 28.345,
    'sigma': 0.0234,
    'gamma': 0.0198,
    'eta': 0.5,
    
    # 单峰拟合的参考参数（用于对比和调试）
    'single_amplitude': 1189.2,
    'single_center': 28.342,
    'single_sigma': 0.0256,
    'single_gamma': 0.0203,
    'single_eta': 0.48,
    
    # 标记信息
    'is_multi_peak': True,
    'group_size': 3,  # 该组有3个重叠峰
    
    # 其他信息
    'x_range': (27.5, 29.5),
    'x_local': [...],
    'y_local': [...],
    'background': [...]
}
```

---

## 用户体验流程

```
1. 加载数据
   │
   ↓
2. 检测峰（自动或手动）
   │
   ↓
3. 点击 "Fit All Peaks"
   │
   ├─ 自动识别重叠峰
   │  (根据 FWHM 和 overlap multiplier)
   │
   ├─ 自动选择拟合策略
   │  • 单峰 → 单独拟合
   │  • 多峰 → 两步拟合
   │
   ├─ 实时显示拟合过程
   │  (控制台输出每个峰的参数)
   │
   └─ 更新图形显示
      • 多层次曲线
      • 连续红色总和线
      • 清晰的峰位标记
```

---

## 控制台输出示例

```bash
=== Multi-peak fitting: 3 overlapping peaks ===
  Peak 1: A=1234.5, C=28.345, σ=0.0234
  Peak 2: A=987.6, C=28.567, σ=0.0198
  Peak 3: A=2345.1, C=28.789, σ=0.0267

  Performing joint multi-peak fit...
  Multi-peak fit completed successfully!
=== Multi-peak fitting completed ===

Fitted 3 peaks (1 multi-peak groups)
```

---

## 关键技术指标

| 项目 | 单峰拟合 | 多峰拟合（旧） | 多峰拟合（新） |
|------|---------|--------------|--------------|
| 拟合窗口 | 3.0 × FWHM | 2.4 × FWHM | Step1: 2.0×, Step2: 2.4× |
| 初始值质量 | 简单估计 | 简单估计 | 基于单峰优化结果 |
| 收敛速度 | 快 | 中等 | 快 |
| 准确度 | 高 | 中等 | 高 |
| 可视化层次 | 1层 | 1层 | 4层 |
| 参数保存 | 1组 | 1组 | 2组 |

---

## 优势总结

### ✅ 拟合质量
- 更好的初始值 → 避免局部最优
- 两步优化 → 结合单峰和多峰优势
- 更准确的参数 → 特别是重叠区域

### ✅ 可视化
- 多层次显示 → 展示拟合过程
- 连续红线 → 清晰直观
- 分段信息 → 科学严谨

### ✅ 可追溯性
- 保存两组参数 → 完整的拟合历史
- 详细输出 → 便于调试
- 质量评估 → 可对比优化效果

### ✅ 用户友好
- 自动化处理 → 无需手动干预
- 实时反馈 → 了解拟合进度
- 向后兼容 → 无缝升级
