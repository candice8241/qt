# æ¨¡å—åˆ†ç¦»è¯´æ˜ - Batch Fitting Module

## æ›´æ–°å†…å®¹

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå®Œæˆä»¥ä¸‹æ¨¡å—é‡ç»„ï¼š

### 1. åˆ›å»ºç‹¬ç«‹çš„ Batch Fitting æ¨¡å— âœ…

**æ–°æ–‡ä»¶ï¼š** `batch_fitting_module.py`

**åŠŸèƒ½ï¼š**
- ç‹¬ç«‹çš„Batchæ‹Ÿåˆå…¥å£ç•Œé¢
- æ¸…æ™°çš„ä½¿ç”¨è¯´æ˜å’ŒåŠŸèƒ½ä»‹ç»
- ç‚¹å‡»"Launch Batch Fitting"æ‰“å¼€å®Œæ•´çš„Auto Fittingç•Œé¢
- åˆ©ç”¨Auto Fitting Moduleçš„å®Œæ•´batchåŠŸèƒ½

**ç•Œé¢è®¾è®¡ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ğŸ“Š Batch Peak Fitting         â”‚
â”‚  Automated batch processing for    â”‚
â”‚  multiple XRD data files           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â„¹ï¸ How to Use:                     â”‚
â”‚  1. Click 'Launch Batch Fitting'   â”‚
â”‚  2. Load XRD data files            â”‚
â”‚  3. Configure batch settings       â”‚
â”‚  4. Click 'Batch Auto Fit'         â”‚
â”‚  5. Results auto-saved to CSV      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ¨ Features:                        â”‚
â”‚  â€¢ Auto peak detection             â”‚
â”‚  â€¢ Interactive verification        â”‚
â”‚  â€¢ Background subtraction          â”‚
â”‚  â€¢ Peak retention across files     â”‚
â”‚  â€¢ Auto-save with CSV summary      â”‚
â”‚  â€¢ Voigt/Pseudo-Voigt functions    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ğŸš€ Launch Batch Fitting          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€æœ¯å®ç°ï¼š**
```python
class BatchFittingModule(QWidget):
    """Standalone Batch Fitting Module"""
    
    def launch_batch_fitting(self):
        """Launch the full Auto Fitting module"""
        if self.auto_fitting_window is None:
            dialog = QDialog(self)
            dialog.setWindowTitle("Batch Peak Fitting - Full Interface")
            dialog.resize(1400, 900)
            
            layout = QVBoxLayout(dialog)
            layout.setContentsMargins(0, 0, 0, 0)
            
            self.auto_fitting_module = AutoFittingModule()
            layout.addWidget(self.auto_fitting_module)
            
            self.auto_fitting_window = dialog
        
        self.auto_fitting_window.show()
```

---

### 2. éšè— curvefit æ¨¡å— âœ…

**ä¿®æ”¹æ–‡ä»¶ï¼š** `main.py`

**æ”¹åŠ¨è¯¦æƒ…ï¼š**

#### 2.1 ä¾§è¾¹æ æŒ‰é’®è°ƒæ•´

**ä¹‹å‰ï¼š**
```python
# Auto Fitting button
self.auto_fitting_btn = ...
sidebar_layout.addWidget(self.auto_fitting_btn)

# Curve Fitting button
self.curvefit_btn = ...
sidebar_layout.addWidget(self.curvefit_btn)

# EOS Fitting button
self.EOSfit_btn = ...
```

**ç°åœ¨ï¼š**
```python
# Auto Fitting button
self.auto_fitting_btn = ...
sidebar_layout.addWidget(self.auto_fitting_btn)

# Batch Fitting button (NEW!)
self.batch_fitting_btn = self.create_sidebar_button("ğŸ“Š  Batch Fit", ...)
sidebar_layout.addWidget(self.batch_fitting_btn)

# Curve Fitting button - HIDDEN
# self.curvefit_btn = ...
# sidebar_layout.addWidget(self.curvefit_btn)

# EOS Fitting button
self.EOSfit_btn = ...
```

#### 2.2 æ¨¡å—å®¹å™¨æ›´æ–°

**æ·»åŠ ï¼š**
```python
self.module_frames = {
    ...
    "batch_fitting": None  # NEW!
}

self.batch_fitting_module = None  # NEW!
```

#### 2.3 ä¾§è¾¹æ æŒ‰é’®å­—å…¸æ›´æ–°

**ä¿®æ”¹ï¼š**
```python
buttons = {
    ...
    "auto_fitting": self.auto_fitting_btn,
    "batch_fitting": self.batch_fitting_btn,  # NEW!
    # "curvefit": self.curvefit_btn,  # HIDDEN
    "eosfit": self.EOSfit_btn
}
```

#### 2.4 æ¨¡å—é¢„æ„å»º

**æ·»åŠ ï¼š**
```python
def prebuild_modules(self):
    ...
    # Prebuild batch fitting module
    batch_fitting_frame = self._ensure_frame("batch_fitting")
    if self.batch_fitting_module is None:
        self.batch_fitting_module = BatchFittingModule()
        batch_fitting_frame.layout().addWidget(self.batch_fitting_module)
    batch_fitting_frame.hide()
```

#### 2.5 æ ‡ç­¾åˆ‡æ¢

**æ·»åŠ ï¼š**
```python
def switch_tab(self, tab_name):
    ...
    elif tab_name == "batch_fitting":
        target_frame = self._ensure_frame("batch_fitting")
        if self.batch_fitting_module is None:
            self.batch_fitting_module = BatchFittingModule()
            target_frame.layout().addWidget(self.batch_fitting_module)
```

---

### 3. å¯¼å…¥æ›´æ–° âœ…

**ä¿®æ”¹ï¼š**
```python
# ä¹‹å‰
from auto_fitting_module import AutoFittingModule

# ç°åœ¨
from auto_fitting_module_v2 import AutoFittingModule
from batch_fitting_module import BatchFittingModule
```

ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„v2.7ç‰ˆæœ¬çš„Auto Fittingæ¨¡å—ã€‚

---

## æ¨¡å—æ¶æ„

```
main.py
â”œâ”€â”€ Mask Module
â”œâ”€â”€ Batch Int. (Powder)
â”œâ”€â”€ BCDI Cal.
â”œâ”€â”€ Dioptas
â”œâ”€â”€ Auto Fit (å•æ–‡ä»¶äº¤äº’å¼æ‹Ÿåˆ)
â”œâ”€â”€ Batch Fit (æ‰¹å¤„ç†æ‹Ÿåˆ) â† NEW!
â”‚   â””â”€â”€ å¯åŠ¨ â†’ Auto Fitting Module (å®Œæ•´ç•Œé¢)
â””â”€â”€ EOSfit

HIDDEN:
âœ— curvefit (Interactive Fitting GUI)
```

---

## ç”¨æˆ·ä½“éªŒ

### ä½¿ç”¨æµç¨‹

#### æ–¹å¼1ï¼šé€šè¿‡Batch Fitæ¨¡å—ï¼ˆæ¨èï¼‰

1. ç‚¹å‡»ä¾§è¾¹æ  "ğŸ“Š  Batch Fit"
2. é˜…è¯»ä½¿ç”¨è¯´æ˜å’ŒåŠŸèƒ½ä»‹ç»
3. ç‚¹å‡» "ğŸš€ Launch Batch Fitting"
4. æ‰“å¼€å®Œæ•´çš„Auto Fittingç•Œé¢
5. ç‚¹å‡» "Batch Auto Fit" å¼€å§‹æ‰¹å¤„ç†

#### æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨Auto Fitæ¨¡å—

1. ç‚¹å‡»ä¾§è¾¹æ  "ğŸ”  Auto Fit"
2. ç›´æ¥è¿›å…¥Auto Fittingå®Œæ•´ç•Œé¢
3. å¯ç”¨äºå•æ–‡ä»¶äº¤äº’å¼æ‹Ÿåˆ
4. ä¹Ÿå¯ç‚¹å‡» "Batch Auto Fit" è¿›è¡Œæ‰¹å¤„ç†

---

## åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | Batch Fitæ¨¡å— | Auto Fitæ¨¡å— |
|------|--------------|--------------|
| ç•Œé¢ | ç®€æ´å¯åŠ¨é¡µ | å®Œæ•´å·¥ä½œç•Œé¢ |
| å•æ–‡ä»¶æ‹Ÿåˆ | âœ— | âœ“ |
| æ‰¹å¤„ç† | âœ“ (è°ƒç”¨Auto Fit) | âœ“ |
| äº¤äº’å¼è°ƒæ•´ | âœ“ (é€šè¿‡Auto Fit) | âœ“ |
| é€‚ç”¨åœºæ™¯ | å¿«é€Ÿæ‰¹å¤„ç†å…¥å£ | å…¨åŠŸèƒ½æ‹Ÿåˆ |

---

## éšè—çš„æ¨¡å—

### curvefit (Interactive Fitting GUI)

**éšè—åŸå› ï¼š** ç”¨æˆ·éœ€æ±‚

**åŠŸèƒ½çŠ¶æ€ï¼š**
- ä»£ç ä¿ç•™åœ¨ `interactive_fitting_gui.py`
- ä¾§è¾¹æ æŒ‰é’®å·²æ³¨é‡Š
- ä¸ä¼šåœ¨ä¸»ç•Œé¢æ˜¾ç¤º
- å¯é€šè¿‡ä»£ç æ‰‹åŠ¨è°ƒç”¨ï¼ˆå¦‚éœ€æ¢å¤ï¼‰

**å¦‚éœ€æ¢å¤ï¼š**
åœ¨ `main.py` ä¸­å–æ¶ˆæ³¨é‡Šï¼š
```python
# Line 161-162 (approximately)
self.curvefit_btn = self.create_sidebar_button("ğŸ“ˆ  curvefit", self.open_curvefit, is_active=False)
sidebar_layout.addWidget(self.curvefit_btn)

# Line 357 (approximately)
"curvefit": self.curvefit_btn,
```

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `batch_fitting_module.py` (214 lines)

### ä¿®æ”¹æ–‡ä»¶
- âœ… `main.py` (æ·»åŠ batchæ¨¡å—ï¼Œéšè—curvefit)

### ä¾èµ–æ–‡ä»¶
- `auto_fitting_module_v2.py` (2449 lines, v2.7)
- `interactive_fitting_gui.py` (ä¿ç•™ä½†éšè—)

---

## æµ‹è¯•æ£€æŸ¥

### å¯åŠ¨æµ‹è¯•
```bash
cd /workspace
python3 main.py
```

### åŠŸèƒ½æµ‹è¯•

#### 1. Batch Fitæ¨¡å—æ˜¾ç¤º
- [ ] ä¾§è¾¹æ æ˜¾ç¤º "ğŸ“Š  Batch Fit" æŒ‰é’®
- [ ] ç‚¹å‡»åæ˜¾ç¤ºå¯åŠ¨é¡µé¢
- [ ] é¡µé¢åŒ…å«ä½¿ç”¨è¯´æ˜å’ŒåŠŸèƒ½ä»‹ç»
- [ ] "Launch Batch Fitting" æŒ‰é’®å¯è§

#### 2. å¯åŠ¨å®Œæ•´ç•Œé¢
- [ ] ç‚¹å‡» "Launch Batch Fitting"
- [ ] æ‰“å¼€ç‹¬ç«‹çª—å£ï¼ˆ1400x900ï¼‰
- [ ] æ˜¾ç¤ºAuto Fittingå®Œæ•´ç•Œé¢
- [ ] æ‰€æœ‰æ§åˆ¶æŒ‰é’®å¯ç”¨

#### 3. BatchåŠŸèƒ½æµ‹è¯•
- [ ] å¯ä»¥åŠ è½½æ–‡ä»¶
- [ ] Batch Auto FitæŒ‰é’®å¯ç‚¹å‡»
- [ ] Batchè®¾ç½®å¯¹è¯æ¡†æ­£å¸¸
- [ ] æ‰¹å¤„ç†æµç¨‹æ­£å¸¸è¿è¡Œ
- [ ] CSVæ±‡æ€»åŠŸèƒ½æ­£å¸¸

#### 4. curvefitéšè—ç¡®è®¤
- [ ] ä¾§è¾¹æ ä¸æ˜¾ç¤º "curvefit" æŒ‰é’®
- [ ] Interactive Fitting GUIä¸ä¼šè‡ªåŠ¨æ‰“å¼€
- [ ] ç¨‹åºè¿è¡Œæ­£å¸¸æ— é”™è¯¯

---

## è®¾è®¡ç†å¿µ

### 1. æ¨¡å—åŒ–è®¾è®¡
- æ¯ä¸ªæ¨¡å—ç‹¬ç«‹å°è£…
- æ¸…æ™°çš„åŠŸèƒ½è¾¹ç•Œ
- ä¾¿äºç»´æŠ¤å’Œæ‰©å±•

### 2. ç”¨æˆ·å‹å¥½
- Batch Fitæ¨¡å—æä¾›æ¸…æ™°çš„å…¥å£
- ä½¿ç”¨è¯´æ˜ä¸€ç›®äº†ç„¶
- é™ä½å­¦ä¹ æˆæœ¬

### 3. åŠŸèƒ½å¤ç”¨
- Batch Fitå¤ç”¨Auto Fitçš„å®Œæ•´åŠŸèƒ½
- é¿å…ä»£ç é‡å¤
- ä¿æŒåŠŸèƒ½ä¸€è‡´æ€§

### 4. çµæ´»æ€§
- æä¾›ä¸¤ç§è®¿é—®æ–¹å¼
- ç”¨æˆ·å¯æ ¹æ®éœ€æ±‚é€‰æ‹©
- éšè—çš„æ¨¡å—å¯è½»æ¾æ¢å¤

---

## æ³¨æ„äº‹é¡¹

1. **çª—å£ç®¡ç†**
   - Batch Fitå¯åŠ¨çš„æ˜¯ç‹¬ç«‹çª—å£
   - å…³é—­çª—å£ä¸å½±å“ä¸»ç¨‹åº
   - å¯é‡å¤æ‰“å¼€

2. **çŠ¶æ€ä¿æŒ**
   - æ‰¹å¤„ç†çŠ¶æ€åœ¨Auto Fittingæ¨¡å—ä¸­ç®¡ç†
   - çª—å£å…³é—­åçŠ¶æ€é‡ç½®
   - æ¯æ¬¡å¯åŠ¨éƒ½æ˜¯æ–°å®ä¾‹

3. **æ€§èƒ½è€ƒè™‘**
   - Batch Fitæ¨¡å—è½»é‡çº§
   - Auto Fittingæ¨¡å—æŒ‰éœ€åŠ è½½
   - ä¸å½±å“ä¸»ç¨‹åºæ€§èƒ½

4. **å‘åå…¼å®¹**
   - Auto Fitæ¨¡å—åŠŸèƒ½ä¸å˜
   - å¯ç‹¬ç«‹ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
   - Batch Fitåªæ˜¯å¿«æ·å…¥å£

---

## ç‰ˆæœ¬ä¿¡æ¯

**å½“å‰ç‰ˆæœ¬ï¼š** Module Reorganization v1.0
**æ›´æ–°æ—¥æœŸï¼š** 2025-12-03
**çŠ¶æ€ï¼š** âœ… æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶é€šè¿‡ç¼–è¯‘æ£€æŸ¥
**å…¼å®¹æ€§ï¼š** åŸºäº Auto Fitting Module v2.7

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **Batch Fitç•Œé¢å¢å¼º**
   - æ·»åŠ æ‰¹å¤„ç†å†å²è®°å½•
   - æ˜¾ç¤ºæœ€è¿‘å¤„ç†çš„æ–‡ä»¶
   - å¿«é€Ÿé‡æ–°å¤„ç†åŠŸèƒ½

2. **è®¾ç½®é¢„è®¾**
   - ä¿å­˜å¸¸ç”¨çš„batchè®¾ç½®
   - å¿«é€ŸåŠ è½½é¢„è®¾é…ç½®
   - å¯¼å…¥/å¯¼å‡ºè®¾ç½®æ–‡ä»¶

3. **è¿›åº¦å¯è§†åŒ–**
   - åœ¨Batch Fitå¯åŠ¨é¡µæ˜¾ç¤ºå¤„ç†è¿›åº¦
   - å®æ—¶æ›´æ–°å¤„ç†çŠ¶æ€
   - å®Œæˆåè¿”å›æ‘˜è¦

4. **æ–‡æ¡£å®Œå–„**
   - æ·»åŠ è§†é¢‘æ•™ç¨‹é“¾æ¥
   - è¯¦ç»†çš„batchè®¾ç½®è¯´æ˜
   - å¸¸è§é—®é¢˜è§£ç­”

---

**å®ŒæˆçŠ¶æ€ï¼š** âœ… æ‰€æœ‰éœ€æ±‚å·²å®ç°
**æµ‹è¯•çŠ¶æ€ï¼š** â³ ç­‰å¾…ç”¨æˆ·æµ‹è¯•ç¡®è®¤
