# æ›´æ–°è¯´æ˜ - ä¸‰é¡¹ä¿®å¤

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. âœ… ä¿®æ”¹ Search Size åˆå§‹å€¼ä¸º 4

**ä¿®æ”¹ä½ç½®**: `calibrate_module.py` - ç¬¬ 872-883 è¡Œ

**å˜æ›´å†…å®¹**:
```python
# ä¹‹å‰
self.search_size_sb.setMinimum(5)
self.search_size_sb.setValue(10)

# ç°åœ¨
self.search_size_sb.setMinimum(1)   # å…è®¸æ›´å°çš„å€¼
self.search_size_sb.setValue(4)     # é»˜è®¤å€¼æ”¹ä¸º 4
```

**è¯´æ˜**: Search size æ§åˆ¶å³°å€¼æœç´¢åŒºåŸŸçš„å¤§å°ï¼Œç°åœ¨é»˜è®¤ä¸º 4 åƒç´ ï¼ˆæ›´ç²¾ç¡®ï¼‰ã€‚

---

### 2. âœ… ä¿®å¤ Save Calibration æŒ‰é’®ï¼ˆä¿å­˜ PONI æ–‡ä»¶ï¼‰

**ä¿®æ”¹ä½ç½®**: `calibrate_module.py` - ç¬¬ 3091-3135 è¡Œ

**ä¿®å¤å†…å®¹**:
1. æ”¹è¿›äº†è·¯å¾„å¤„ç†é€»è¾‘
2. è‡ªåŠ¨æ·»åŠ  `.poni` æ‰©å±•å
3. å¢å¼ºäº†é”™è¯¯å¤„ç†
4. æ·»åŠ äº†æ›´è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

**ä¿®å¤çš„ä»£ç **:
```python
def save_poni_file(self):
    """Save PONI file"""
    if self.ai is None:
        QMessageBox.warning(self.parent, "No Calibration", 
                          "Please run calibration first before saving PONI file.")
        return
    
    # è·å–è·¯å¾„æˆ–æ˜¾ç¤ºå¯¹è¯æ¡†
    poni_path = None
    if hasattr(self, 'poni_entry') and self.poni_entry.text().strip():
        poni_path = self.poni_entry.text().strip()
    
    if not poni_path:
        # æ˜¾ç¤ºæ–‡ä»¶å¯¹è¯æ¡†
        poni_path, _ = QFileDialog.getSaveFileName(
            self.parent, 
            "Save PONI File", 
            "calibration.poni",
            "PONI Files (*.poni);;All Files (*.*)"
        )
    
    if poni_path:
        try:
            # ç¡®ä¿æœ‰ .poni æ‰©å±•å
            if not poni_path.endswith('.poni'):
                poni_path += '.poni'
            
            # ä½¿ç”¨ pyFAI çš„ save æ–¹æ³•ä¿å­˜
            self.ai.save(poni_path)
            
            self.log(f"âœ“ PONI file saved to: {poni_path}")
            QMessageBox.information(self.parent, "Success", 
                                  f"PONI file saved successfully!\n{poni_path}")
            
            # æ›´æ–°æ–‡æœ¬æ¡†
            if hasattr(self, 'poni_entry'):
                self.poni_entry.setText(poni_path)
                
        except Exception as e:
            # è¯¦ç»†çš„é”™è¯¯å¤„ç†
            import traceback
            error_detail = traceback.format_exc()
            self.log(f"Error saving PONI: {str(e)}")
            self.log(error_detail)
            QMessageBox.critical(self.parent, "Error", 
                               f"Failed to save PONI file:\n{str(e)}\n\nCheck log for details.")
```

**ç°åœ¨å¯ä»¥**:
- âœ… ç‚¹å‡» "ğŸ’¾ Save PONI" æŒ‰é’®æ­£å¸¸å·¥ä½œ
- âœ… è‡ªåŠ¨å¼¹å‡ºæ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†
- âœ… è‡ªåŠ¨æ·»åŠ  .poni æ‰©å±•å
- âœ… æ˜¾ç¤ºæˆåŠŸæˆ–é”™è¯¯æ¶ˆæ¯

---

### 3. âœ… ä¿®æ­£ Cake è§†å›¾ç»˜åˆ¶ï¼ˆDioptas é£æ ¼ï¼‰

**ä¿®æ”¹ä½ç½®**: `calibrate_module.py` - ç¬¬ 3331-3419 è¡Œ

**æ”¹è¿›å†…å®¹**:

1. **æ­£ç¡®çš„ç§¯åˆ†å‚æ•°** (æŒ‰ Dioptas æ ‡å‡†):
   ```python
   result = self.ai.integrate2d(
       self.current_image,
       npt_rad=1024,        # æ›´é«˜åˆ†è¾¨ç‡
       npt_azim=360,        # 360Â° (1Â° per bin)
       unit="2th_deg",      # 2theta å•ä½ï¼ˆåº¦ï¼‰
       method="bbox",       # å¿«é€Ÿæ–¹æ³•
       correctSolidAngle=False  # Dioptas é»˜è®¤ä¸åº”ç”¨
   )
   ```

2. **æ­£ç¡®çš„åæ ‡è½´æ–¹å‘**:
   - X è½´: 2Î¸ (degrees)
   - Y è½´: Azimuth (degrees)
   - Origin: lower (å·¦ä¸‹è§’)

3. **Dioptas é£æ ¼çš„æ˜¾ç¤º**:
   - ä½¿ç”¨ `jet` è‰²å½©æ˜ å°„ï¼ˆDioptas é»˜è®¤ï¼‰
   - Log10 ç¼©æ”¾ï¼ˆæ›´å¥½çš„å¯¹æ¯”åº¦ï¼‰
   - è‡ªåŠ¨ç¼©æ”¾åˆ° 99.5 ç™¾åˆ†ä½
   - ç™½è‰²æ ‡å®šçº¿ï¼ˆå‚ç›´çº¿ï¼‰

4. **æ­£ç¡®çš„å›¾åƒæ–¹å‘**:
   ```python
   # ç¡®ä¿æ­£ç¡®çš„æ–¹å‘ (azimuth, 2theta)
   if cake_display.shape[0] != len(chi_edges) - 1:
       cake_display = cake_display.T
   ```

**æ•ˆæœ**:
- âœ… Cake å›¾åƒæ–¹å‘æ­£ç¡®ï¼ˆ2Î¸ åœ¨ X è½´ï¼Œæ–¹ä½è§’åœ¨ Y è½´ï¼‰
- âœ… æ ‡å®šçº¿æ˜¾ç¤ºä¸ºå‚ç›´çº¿ï¼ˆå¦‚æœæ ‡å®šæ­£ç¡®ï¼‰
- âœ… é¢œè‰²å’Œå¯¹æ¯”åº¦ç¬¦åˆ Dioptas é£æ ¼

---

### 4. âœ… ä¿®æ­£ Pattern è§†å›¾ç»˜åˆ¶ï¼ˆDioptas é£æ ¼ï¼‰

**ä¿®æ”¹ä½ç½®**: `calibrate_module.py` - ç¬¬ 3456-3513 è¡Œ

**æ”¹è¿›å†…å®¹**:

1. **æ­£ç¡®çš„ç§¯åˆ†å‚æ•°** (æŒ‰ Dioptas æ ‡å‡†):
   ```python
   result = self.ai.integrate1d(
       self.current_image,
       npt=2048,              # 2048 ä¸ªç‚¹
       unit="2th_deg",        # 2theta å•ä½ï¼ˆåº¦ï¼‰
       method="bbox",         # å¿«é€Ÿæ–¹æ³•
       correctSolidAngle=False,      # Dioptas é»˜è®¤ä¸åº”ç”¨
       polarization_factor=None      # æ— åæŒ¯æ ¡æ­£
   )
   ```

2. **Dioptas é£æ ¼çš„å›¾è¡¨**:
   - è“è‰²çº¿æ¡ï¼ˆ`'b-'`ï¼‰
   - ç»†ç½‘æ ¼çº¿ï¼ˆè™šçº¿ï¼Œalpha=0.3ï¼‰
   - åˆé€‚çš„æ ‡ç­¾å­—ä½“å’Œå¤§å°
   - è‡ªåŠ¨ Y è½´ç¼©æ”¾ï¼ˆ99.5 ç™¾åˆ†ä½ï¼‰

3. **æ ‡å®šå³°ä½æ ‡è®°**:
   ```python
   # çº¢è‰²è™šçº¿æ ‡è®°é¢„æœŸçš„å³°ä½
   self.pattern_axes.axvline(peak_2th, color='red', linestyle='--', 
                            alpha=0.4, linewidth=0.8)
   ```

4. **æ­£ç¡®çš„åæ ‡è½´**:
   - X è½´: 2Î¸ (Â°)
   - Y è½´: Intensity (counts)
   - X èŒƒå›´: å®Œæ•´çš„ 2theta èŒƒå›´
   - Y èŒƒå›´: è‡ªåŠ¨ç¼©æ”¾ï¼Œå»é™¤å¼‚å¸¸å€¼

**æ•ˆæœ**:
- âœ… 1D ç§¯åˆ†å›¾æ­£ç¡®æ˜¾ç¤º
- âœ… å³°ä½æ¸…æ™°å¯è§
- âœ… æ ‡å®šçº¿ä½ç½®æ­£ç¡®
- âœ… ç¬¦åˆ Dioptas çš„æ˜¾ç¤ºé£æ ¼

---

## ğŸ“Š ä¸ Dioptas çš„å¯¹æ¯”

### Cake è§†å›¾

| ç‰¹æ€§ | Dioptas | æœ¬å®ç° |
|------|---------|--------|
| è‰²å½©æ˜ å°„ | jet | âœ… jet |
| ç¼©æ”¾æ–¹å¼ | log10 | âœ… log10 |
| X è½´ | 2Î¸ (Â°) | âœ… 2Î¸ (Â°) |
| Y è½´ | Azimuth (Â°) | âœ… Azimuth (Â°) |
| æ ‡å®šçº¿ | ç™½è‰²å‚ç›´çº¿ | âœ… ç™½è‰²å‚ç›´çº¿ |
| ç§¯åˆ†æ–¹æ³• | bbox | âœ… bbox |

### Pattern è§†å›¾

| ç‰¹æ€§ | Dioptas | æœ¬å®ç° |
|------|---------|--------|
| çº¿æ¡é¢œè‰² | è“è‰² | âœ… è“è‰² |
| X è½´ | 2Î¸ (Â°) | âœ… 2Î¸ (Â°) |
| Y è½´ | Intensity | âœ… Intensity |
| ç½‘æ ¼ | è™šçº¿ | âœ… è™šçº¿ |
| æ ‡å®šçº¿ | çº¢è‰²è™šçº¿ | âœ… çº¢è‰²è™šçº¿ |
| ç‚¹æ•° | 2048 | âœ… 2048 |

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### ä¿å­˜ PONI æ–‡ä»¶

```
1. è¿è¡Œæ ‡å®šï¼ˆç‚¹å‡» "ğŸ¯ Run Calibration"ï¼‰

2. æ ‡å®šå®Œæˆåï¼Œç‚¹å‡» "ğŸ’¾ Save PONI"

3. é€‰æ‹©ä¿å­˜ä½ç½®å’Œæ–‡ä»¶å

4. å®Œæˆï¼PONI æ–‡ä»¶å·²ä¿å­˜
```

### æŸ¥çœ‹ Cake è§†å›¾

```
1. æ ‡å®šå®Œæˆå

2. åˆ‡æ¢åˆ° "Cake" æ ‡ç­¾é¡µ

3. æŸ¥çœ‹æåæ ‡å˜æ¢ç»“æœ
   - X è½´ï¼š2Î¸ è§’åº¦
   - Y è½´ï¼šæ–¹ä½è§’ï¼ˆ0-360Â°ï¼‰
   - å‚ç›´ç™½çº¿ï¼šæ ‡å®šå³°ä½
```

### æŸ¥çœ‹ Pattern è§†å›¾

```
1. æ ‡å®šå®Œæˆå

2. åˆ‡æ¢åˆ° "Pattern" æ ‡ç­¾é¡µ

3. æŸ¥çœ‹ 1D ç§¯åˆ†å›¾æ¡ˆ
   - è“è‰²çº¿ï¼šç§¯åˆ†å¼ºåº¦
   - çº¢è‰²è™šçº¿ï¼šé¢„æœŸå³°ä½
```

---

## âœ… æµ‹è¯•æ£€æŸ¥

- [x] Search size é»˜è®¤å€¼ä¸º 4
- [x] Save PONI æŒ‰é’®å·¥ä½œæ­£å¸¸
- [x] Cake è§†å›¾æ–¹å‘æ­£ç¡®
- [x] Pattern è§†å›¾æ˜¾ç¤ºæ­£ç¡®
- [x] ä»£ç è¯­æ³•æ— é”™è¯¯
- [x] æ—  linter è­¦å‘Š

---

## ğŸ“ ä»£ç å˜æ›´ç»Ÿè®¡

### calibrate_module.py

| ä¿®æ”¹é¡¹ | å˜æ›´ |
|--------|------|
| Search size åˆå§‹å€¼ | 10 â†’ 4 |
| Search size æœ€å°å€¼ | 5 â†’ 1 |
| save_poni_file æ–¹æ³• | å¢å¼ºé”™è¯¯å¤„ç†å’Œè·¯å¾„å¤„ç† |
| update_cake_view æ–¹æ³• | å®Œå…¨é‡å†™ï¼ˆæŒ‰ Dioptas æ ‡å‡†ï¼‰ |
| update_pattern_view æ–¹æ³• | å®Œå…¨é‡å†™ï¼ˆæŒ‰ Dioptas æ ‡å‡†ï¼‰ |

**æ€»è®¡**:
- ä¿®æ”¹è¡Œæ•°ï¼š~150 è¡Œ
- æ–°å¢æ³¨é‡Šï¼š~30 è¡Œ
- æ”¹è¿›æ–¹æ³•ï¼š3 ä¸ª

---

## ğŸ‰ æ€»ç»“

âœ… **æ‰€æœ‰é—®é¢˜å·²è§£å†³ï¼**

1. âœ… Search size é»˜è®¤å€¼æ”¹ä¸º 4
2. âœ… Save PONI æŒ‰é’®æ­£å¸¸å·¥ä½œ
3. âœ… Cake è§†å›¾æŒ‰ Dioptas æ–¹å¼æ˜¾ç¤º
4. âœ… Pattern è§†å›¾æŒ‰ Dioptas æ–¹å¼æ˜¾ç¤º

**ç°åœ¨çš„æ ‡å®šæ¨¡å—å®Œå…¨ç¬¦åˆ Dioptas çš„æ˜¾ç¤ºæ ‡å‡†ï¼** âœ¨

---

**æ›´æ–°æ—¥æœŸ**: 2025å¹´12æœˆ5æ—¥  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**ä»£ç è´¨é‡**: âœ… æ— é”™è¯¯
