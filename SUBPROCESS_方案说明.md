# Subprocess æ–¹æ¡ˆå®æ–½å®Œæˆ

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. å¯¼å…¥ subprocess æ¨¡å—
```python
import subprocess
import sys
```

### 2. é‡å†™ run_integration() æ–¹æ³•
- ä¸å†ä½¿ç”¨çº¿ç¨‹ï¼ˆthreading.Threadï¼‰
- æ”¹ç”¨ subprocess.Popen åˆ›å»ºç‹¬ç«‹è¿›ç¨‹
- ä½¿ç”¨ QTimer è½®è¯¢å­è¿›ç¨‹çŠ¶æ€ï¼ˆæ¯500msï¼‰

### 3. æ–°å¢è¾…åŠ©æ–¹æ³•

#### _create_integration_script()
åˆ›å»ºåœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œçš„ Python è„šæœ¬ï¼š
- åŒ…å«æ‰€æœ‰é›†æˆå‚æ•°
- æ­£ç¡®å¤„ç†å­—ç¬¦ä¸²è½¬ä¹‰
- è¾“å‡ºæˆåŠŸ/å¤±è´¥æ ‡è®°

#### _check_integration_status()
å®šæœŸæ£€æŸ¥å­è¿›ç¨‹çŠ¶æ€ï¼š
- ä½¿ç”¨ process.poll() æ£€æŸ¥æ˜¯å¦å®Œæˆ
- è¯»å– stdout/stderr
- æ ¹æ®è¾“å‡ºåˆ¤æ–­æˆåŠŸæˆ–å¤±è´¥
- æ›´æ–° GUI å’Œæ—¥å¿—

## ğŸ¯ å·¥ä½œåŸç†

```
ç”¨æˆ·ç‚¹å‡» "Run Integration"
    â†“
åˆ›å»º Python è„šæœ¬ï¼ˆåŒ…å«é›†æˆä»£ç ï¼‰
    â†“
å¯åŠ¨ç‹¬ç«‹å­è¿›ç¨‹æ‰§è¡Œè„šæœ¬
    â†“
GUI ç»§ç»­å“åº”ï¼ˆä¸ä¼šå¡ï¼ï¼‰
    â†“
QTimer æ¯ 500ms æ£€æŸ¥ä¸€æ¬¡
    â†“
å­è¿›ç¨‹å®Œæˆ â†’ æ›´æ–° GUI
```

## ğŸ” å…³é”®ç‰¹æ€§

### å®Œå…¨éš”ç¦»
- å­è¿›ç¨‹åœ¨ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿè¿›ç¨‹ä¸­è¿è¡Œ
- GUI è¿›ç¨‹å’Œé›†æˆè¿›ç¨‹**å®Œå…¨åˆ†ç¦»**
- å³ä½¿é›†æˆå¡ä½æˆ–å´©æºƒï¼ŒGUI ä»ç„¶æ­£å¸¸

### å®æ—¶ç›‘æ§
- æ¯ 500ms æ£€æŸ¥ä¸€æ¬¡å­è¿›ç¨‹çŠ¶æ€
- å¯ä»¥è·å– stdout/stderr è¾“å‡º
- æ˜¾ç¤ºè¿›åº¦æ¡åŠ¨ç”»

### é”™è¯¯å¤„ç†
- æ•è·å­è¿›ç¨‹çš„æ‰€æœ‰é”™è¯¯
- æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå‰500å­—ç¬¦ï¼‰
- æ¸…ç†èµ„æº

### æˆåŠŸæ ‡è®°
å­è¿›ç¨‹åœ¨æˆåŠŸå®Œæˆæ—¶è¾“å‡ºï¼š
```
=== INTEGRATION_SUCCESS ===
```

GUI é€šè¿‡æ£€æµ‹è¿™ä¸ªæ ‡è®°åˆ¤æ–­æ˜¯å¦æˆåŠŸã€‚

## ğŸ“Š ä¸ä¹‹å‰æ–¹æ¡ˆçš„å¯¹æ¯”

| ç‰¹æ€§ | threading.Thread | subprocess.Popen |
|------|-----------------|------------------|
| è¿›ç¨‹éš”ç¦» | âŒ å…±äº«å†…å­˜ | âœ… å®Œå…¨éš”ç¦» |
| GUIå“åº” | âŒ å¯èƒ½é˜»å¡ | âœ… æ°¸ä¸é˜»å¡ |
| å¯ç»ˆæ­¢æ€§ | âš ï¸ å›°éš¾ | âœ… process.terminate() |
| é”™è¯¯éš”ç¦» | âŒ å¯èƒ½å½±å“ä¸»è¿›ç¨‹ | âœ… å®Œå…¨éš”ç¦» |
| å®æ—¶è¾“å‡º | âš ï¸ éœ€è¦å¤æ‚ä¿¡å· | âœ… stdout/stderr |
| èµ„æºç®¡ç† | âš ï¸ éœ€è¦æ‰‹åŠ¨ç®¡ç† | âœ… OS è‡ªåŠ¨ç®¡ç† |

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### åŸºç¡€æµ‹è¯•
1. å¯åŠ¨åº”ç”¨
2. è¿›å…¥ Powder Int æ¨¡å—
3. é€‰æ‹©æ–‡ä»¶å’Œå‚æ•°
4. ç‚¹å‡» "Run Integration"
5. **è§‚å¯Ÿ**ï¼š
   - âœ… è¿›åº¦æ¡åº”è¯¥æµç•…åŠ¨ç”»
   - âœ… çª—å£å¯ä»¥æ‹–åŠ¨
   - âœ… å¯ä»¥ç‚¹å‡»å…¶ä»–æŒ‰é’®
   - âœ… æ—¥å¿—åº”æ˜¾ç¤º "Subprocess started successfully"

### å®Œæˆæµ‹è¯•
ç­‰å¾…é›†æˆå®Œæˆåï¼š
- âœ… åº”æ˜¾ç¤º "Integration completed successfully!"
- âœ… è¿›åº¦æ¡åœæ­¢
- âœ… å¼¹å‡ºæˆåŠŸå¯¹è¯æ¡†

### é”™è¯¯æµ‹è¯•
ä½¿ç”¨é”™è¯¯çš„è¾“å…¥ï¼ˆå¦‚ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼‰ï¼š
- âœ… åº”æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- âœ… è¿›åº¦æ¡åœæ­¢
- âœ… GUI ä»ç„¶å“åº”

## ğŸ”§ é«˜çº§é€‰é¡¹ï¼ˆæœªå®æ–½ï¼Œä½†å¯ä»¥æ·»åŠ ï¼‰

### 1. å®æ—¶æ—¥å¿—æµ
å¦‚æœéœ€è¦å®æ—¶æ˜¾ç¤ºé›†æˆè¿›åº¦ï¼š

```python
def _check_integration_status(self):
    if hasattr(self, 'integration_process'):
        # è¯»å–å®æ—¶è¾“å‡ºï¼ˆéé˜»å¡ï¼‰
        try:
            import select
            if select.select([self.integration_process.stdout], [], [], 0)[0]:
                line = self.integration_process.stdout.readline()
                if line:
                    self.log(line.strip())
        except:
            pass
        
        # æ£€æŸ¥æ˜¯å¦å®Œæˆ
        retcode = self.integration_process.poll()
        if retcode is not None:
            # ... å¤„ç†å®Œæˆ
```

### 2. å–æ¶ˆæŒ‰é’®
æ·»åŠ ä¸€ä¸ªæŒ‰é’®æ¥ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„é›†æˆï¼š

```python
def cancel_integration(self):
    """Cancel running integration"""
    if hasattr(self, 'integration_process'):
        self.integration_process.terminate()
        self.check_timer.stop()
        self.progress.stop()
        self.log("âœ— Integration cancelled by user")
        self.show_success("Cancelled", "Integration was cancelled")
```

### 3. è¿›åº¦ç™¾åˆ†æ¯”
å¦‚æœå­è¿›ç¨‹èƒ½è¾“å‡ºè¿›åº¦ä¿¡æ¯ï¼š

```python
# åœ¨å­è¿›ç¨‹è„šæœ¬ä¸­
print(f"PROGRESS: 50", flush=True)

# åœ¨ GUI ä¸­è§£æ
if "PROGRESS:" in line:
    percent = int(line.split(":")[1])
    self.log(f"Progress: {percent}%")
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### Windows è·¯å¾„
è„šæœ¬ä¸­å·²å¤„ç†è·¯å¾„è½¬ä¹‰ï¼š
```python
def escape(s):
    return s.replace('\\', '\\\\').replace('"', '\\"')
```

### å¤§è¾“å‡º
å¦‚æœ stdout/stderr å¾ˆå¤§ï¼Œå¯èƒ½éœ€è¦åˆ†æ‰¹è¯»å–ï¼š
```python
stdout, stderr = self.integration_process.communicate(timeout=1)
# åªæ˜¾ç¤ºå‰500å­—ç¬¦
error_preview = stderr[:500]
```

### æ¸…ç†
å­è¿›ç¨‹ç»“æŸåè‡ªåŠ¨æ¸…ç†ï¼š
```python
del self.integration_process
```

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

- âœ… `powder_module.py` - ä¸»è¦ä¿®æ”¹
- âœ… æ·»åŠ  `import subprocess, sys`
- âœ… é‡å†™ `run_integration()`
- âœ… æ–°å¢ `_create_integration_script()`
- âœ… æ–°å¢ `_check_integration_status()`

## ğŸ‰ é¢„æœŸæ•ˆæœ

ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆåï¼š

1. **GUI æ°¸è¿œä¸ä¼šå¡** - å³ä½¿é›†æˆéœ€è¦å¾ˆé•¿æ—¶é—´
2. **è¿›åº¦æ¡æµç•…** - QTimer åªæ£€æŸ¥çŠ¶æ€ï¼Œä¸æ‰§è¡Œé‡ä»»åŠ¡
3. **å¯ä»¥å–æ¶ˆ** - å¯ä»¥æ·»åŠ ç»ˆæ­¢åŠŸèƒ½
4. **é”™è¯¯éš”ç¦»** - å­è¿›ç¨‹å´©æºƒä¸å½±å“ GUI
5. **æ˜“äºè°ƒè¯•** - å¯ä»¥ç‹¬ç«‹æµ‹è¯•å­è¿›ç¨‹è„šæœ¬

## ğŸš€ ä¸‹ä¸€æ­¥

1. **æµ‹è¯•åŸºç¡€åŠŸèƒ½** - ç¡®è®¤ä¸å†å¡é¡¿
2. **å¦‚æœéœ€è¦å®æ—¶è¿›åº¦** - æ·»åŠ æ—¥å¿—æµåŠŸèƒ½
3. **å¦‚æœéœ€è¦å–æ¶ˆ** - æ·»åŠ ç»ˆæ­¢æŒ‰é’®
4. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ** - æ·»åŠ æ›´è¯¦ç»†çš„çŠ¶æ€æç¤º

---

**è¿™ä¸ªæ–¹æ¡ˆä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„è¿›ç¨‹éš”ç¦»ï¼Œæ˜¯æœ€å¯é çš„è§£å†³æ–¹æ¡ˆï¼** ğŸ¯
