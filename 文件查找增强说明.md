# æ–‡ä»¶æŸ¥æ‰¾åŠŸèƒ½å¢å¼ºè¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š**ä»ç„¶æ²¡æœ‰éå†è¾“å…¥æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰h5æ–‡ä»¶**

## ğŸ” é—®é¢˜åˆ†æ

åŸæœ‰çš„4å±‚fallbackæœºåˆ¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **Method 4 ä½¿ç”¨äº† `recursive=False`** - è¿™å¯¼è‡´æ— æ³•é€’å½’æœç´¢å­ç›®å½•
2. **ç¼ºå°‘è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯** - ç”¨æˆ·æ— æ³•çœ‹åˆ°å…·ä½“å“ªä¸€æ­¥å¤±è´¥
3. **è·¯å¾„æ¸…ç†ä¸å®Œæ•´** - å¯¹äºå¸¦å°¾éšæ–œæ æˆ–é€šé…ç¬¦çš„è·¯å¾„å¤„ç†ä¸å¤Ÿå¥½
4. **ç¼ºå°‘parent directory fallback** - æŸäº›æƒ…å†µä¸‹è¾“å…¥çš„è·¯å¾„å¯èƒ½ä¸å®Œæ•´

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å®ç°5å±‚Fallbackæœºåˆ¶

```python
# Method 1: ç›´æ¥å°è¯•patternï¼Œå¯ç”¨recursive
h5_files = sorted(glob.glob(input_pattern, recursive=True))

# Method 2: æ£€æµ‹åˆ°æ˜¯ç›®å½•ï¼Œè‡ªåŠ¨æ·»åŠ  **/*.h5
if not h5_files and os.path.isdir(input_pattern):
    pattern = os.path.join(input_pattern, '**', '*.h5')
    h5_files = sorted(glob.glob(pattern, recursive=True))

# Method 3: å°† *.h5 è½¬æ¢ä¸º **/*.h5 è¿›è¡Œé€’å½’æœç´¢
if not h5_files and '*.h5' in input_pattern and '**' not in input_pattern:
    base_dir = input_pattern[:-len('*.h5')].rstrip('/\\')
    recursive_pattern = os.path.join(base_dir, '**', '*.h5')
    h5_files = sorted(glob.glob(recursive_pattern, recursive=True))

# Method 4: æ¸…ç†è·¯å¾„å¹¶å°è¯•é€’å½’æœç´¢
if not h5_files:
    clean_path = input_pattern.rstrip('/*')
    if os.path.isdir(clean_path):
        recursive_pattern = os.path.join(clean_path, '**', '*.h5')
        h5_files = sorted(glob.glob(recursive_pattern, recursive=True))

# Method 5: å°è¯•çˆ¶ç›®å½•ï¼ˆå¤„ç†ä¸å®Œæ•´è·¯å¾„ï¼‰
if not h5_files and os.path.sep in input_pattern:
    parent_dir = os.path.dirname(input_pattern)
    if parent_dir and os.path.isdir(parent_dir):
        recursive_pattern = os.path.join(parent_dir, '**', '*.h5')
        h5_files = sorted(glob.glob(recursive_pattern, recursive=True))
```

### 2. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•è¾“å‡º

æ¯ä¸ªæ­¥éª¤éƒ½ä¼šè¾“å‡ºï¼š
- ğŸ” æœç´¢å¼€å§‹ä¿¡æ¯ï¼ˆè¾“å…¥ç±»å‹ã€æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦ä¸ºç›®å½•ï¼‰
- ğŸ“‚ æ¯ä¸ªMethodçš„å°è¯•è¿‡ç¨‹
- âœ“ æˆåŠŸæ‰¾åˆ°æ–‡ä»¶æ—¶çš„ç¡®è®¤ä¿¡æ¯
- ğŸ“‹ ç¤ºä¾‹æ–‡ä»¶åˆ—è¡¨ï¼ˆå‰3ä¸ªï¼‰
- âš  å¤±è´¥æ—¶çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
ğŸ” Starting file search with input: /path/to/data
   Input type: <class 'str'>
   Is directory: True
   Exists: True

ğŸ“‚ Method 1: Trying pattern as-is with recursive=True...
   Result: Found 0 files

ğŸ“‚ Method 2: Directory detected, searching recursively for **/*.h5...
   Pattern: /path/to/data/**/*.h5
   Result: Found 15 files
   âœ“ Success! Found 15 .h5 files in directory: /path/to/data
   Sample files: ['/path/to/data/sub1/file1.h5', '/path/to/data/sub1/file2.h5', ...]

âœ“ Final result: Found 15 HDF5 files to process
```

### 3. å¢å¼ºé”™è¯¯æç¤º

å½“æ‰¾ä¸åˆ°æ–‡ä»¶æ—¶ï¼Œä¼šï¼š
- æ˜¾ç¤ºè¾“å…¥çš„patternå’Œç»å¯¹è·¯å¾„
- æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•
- æä¾›ä½¿ç”¨å»ºè®®
- **è‡ªåŠ¨åˆ—å‡ºç›®å½•ä¸­å®é™…å­˜åœ¨çš„.h5æ–‡ä»¶**

**é”™è¯¯è¾“å‡ºç¤ºä¾‹**ï¼š
```
âš  ERROR: No matching .h5 files found!
  Input pattern: /wrong/path
  Absolute path: /wrong/path
  Current directory: /workspace

  ğŸ’¡ Tips:
    - For all files in a directory (recursive): /path/to/dir
    - For files matching pattern: /path/to/dir/*.h5
    - For recursive search: /path/to/dir/**/*.h5
    - Check if the path exists and contains .h5 files

  ğŸ“‹ Directory contents:
    /path/to/data/run1: 5 .h5 files
    /path/to/data/run2: 10 .h5 files
```

## ğŸ§ª æµ‹è¯•å·¥å…·

åˆ›å»ºäº† `test_file_search.py` ç”¨äºç‹¬ç«‹æµ‹è¯•æ–‡ä»¶æŸ¥æ‰¾åŠŸèƒ½ï¼š

```bash
# æµ‹è¯•ç›®å½•è·¯å¾„
python test_file_search.py /path/to/data

# æµ‹è¯•é€šé…ç¬¦
python test_file_search.py "/path/to/data/*.h5"

# æµ‹è¯•é€’å½’pattern
python test_file_search.py "/path/to/data/**/*.h5"
```

## ğŸ“Š æ”¯æŒçš„è¾“å…¥æ ¼å¼

| è¾“å…¥æ ¼å¼ | ç¤ºä¾‹ | è¡Œä¸º |
|---------|------|------|
| ç›®å½•è·¯å¾„ | `/data` | é€’å½’æœç´¢æ‰€æœ‰.h5æ–‡ä»¶ |
| é€šé…ç¬¦ | `/data/*.h5` | è½¬æ¢ä¸ºé€’å½’æœç´¢ |
| é€’å½’pattern | `/data/**/*.h5` | ç›´æ¥é€’å½’æœç´¢ |
| å¸¦å°¾éšæ–œæ  | `/data/` | è‡ªåŠ¨æ¸…ç†å¹¶é€’å½’æœç´¢ |
| å•ä¸ªæ–‡ä»¶ | `/data/file.h5` | åŒ¹é…è¯¥æ–‡ä»¶ |
| ç›¸å¯¹è·¯å¾„ | `data` | ä»å½“å‰ç›®å½•é€’å½’æœç´¢ |
| ä¸å®Œæ•´è·¯å¾„ | `/data/sub` | å°è¯•parentç›®å½• |

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### ä¿®å¤çš„Bug

1. **Method 4 é€’å½’æ ‡å¿—é”™è¯¯**
   - åŸä»£ç ï¼š`glob.glob(test_pattern, recursive=False)` âŒ
   - ä¿®å¤åï¼šç§»é™¤Method 4ï¼Œæ”¹ç”¨æ›´æ™ºèƒ½çš„pathæ¸…ç†é€»è¾‘ âœ…

2. **è·¯å¾„æ¸…ç†ä¸å®Œæ•´**
   - å¢åŠ ï¼š`clean_path = input_pattern.rstrip('/*')` âœ…
   - å¤„ç†å¸¦å°¾éšæ–œæ å’Œé€šé…ç¬¦çš„è·¯å¾„ âœ…

3. **ç¼ºå°‘fallbackåˆ°parentç›®å½•**
   - æ–°å¢Method 5ï¼šå°è¯•æœç´¢parent directory âœ…

### æ€§èƒ½ä¼˜åŒ–

- æ¯ä¸ªMethodåªåœ¨å‰ä¸€ä¸ªå¤±è´¥æ—¶æ‰æ‰§è¡Œï¼ˆçŸ­è·¯è¯„ä¼°ï¼‰
- ä½¿ç”¨`sorted()`ç¡®ä¿æ–‡ä»¶é¡ºåºä¸€è‡´
- é¿å…é‡å¤æœç´¢ç›¸åŒè·¯å¾„

## âœ… éªŒè¯æ–¹æ³•

### 1. åŸºç¡€æµ‹è¯•
```python
# åœ¨Pythonä¸­æµ‹è¯•
from batch_integration import BatchIntegrator

integrator = BatchIntegrator("test.poni")
integrator.batch_integrate(
    input_pattern="/path/to/data",  # æˆ–å…¶ä»–æ ¼å¼
    output_dir="output",
    disable_progress_bar=True
)
```

### 2. ä½¿ç”¨æµ‹è¯•è„šæœ¬
```bash
python test_file_search.py /path/to/your/data
```

### 3. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
è¿è¡ŒIntegrationåï¼Œæ£€æŸ¥æ—¥å¿—ä¸­çš„æ–‡ä»¶æŸ¥æ‰¾éƒ¨åˆ†ï¼š
- åº”è¯¥çœ‹åˆ°5ä¸ªMethodçš„å°è¯•è¿‡ç¨‹
- æŸä¸ªMethodä¼šæˆåŠŸå¹¶æ˜¾ç¤ºæ‰¾åˆ°çš„æ–‡ä»¶æ•°
- æ˜¾ç¤ºç¤ºä¾‹æ–‡ä»¶è·¯å¾„

## ğŸ“ˆ é¢„æœŸç»“æœ

âœ… **æ‰€æœ‰å­ç›®å½•ä¸­çš„.h5æ–‡ä»¶éƒ½ä¼šè¢«æ‰¾åˆ°**
âœ… **è¯¦ç»†çš„æ—¥å¿—å¸®åŠ©è¯Šæ–­é—®é¢˜**
âœ… **æ”¯æŒå¤šç§è¾“å…¥æ ¼å¼**
âœ… **æ›´å¥½çš„é”™è¯¯æç¤º**

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `batch_integration.py` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `test_file_search.py` - æµ‹è¯•å·¥å…·
- `powder_module.py` - GUIè°ƒç”¨å…¥å£ï¼ˆä½¿ç”¨subprocessï¼‰

## ğŸ“ æäº¤ä¿¡æ¯

```
Commit: bd0c726
Message: Fix: Enhance file discovery with 5-layer fallback and detailed logging

Changes:
- batch_integration.py: +109/-28 lines
- test_file_search.py: +128 new file
```

---

**ä¿®å¤æ—¶é—´**: 2025-12-02  
**PRç¼–å·**: #3  
**çŠ¶æ€**: âœ… å·²æ¨é€åˆ°è¿œç¨‹åˆ†æ”¯
